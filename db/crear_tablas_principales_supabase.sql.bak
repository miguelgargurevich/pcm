-- ====================================
-- CREAR TODAS LAS TABLAS PRINCIPALES EN SUPABASE
-- Script completo e idempotente
-- ====================================

-- PASO 1: Crear tabla perfiles
CREATE TABLE IF NOT EXISTS perfiles (
    perfil_id SMALLSERIAL PRIMARY KEY,
    nombre VARCHAR(50) UNIQUE NOT NULL,
    descripcion VARCHAR(200) NOT NULL,
    activo BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- PASO 2: Crear tabla ubigeo
CREATE TABLE IF NOT EXISTS ubigeo (
    ubigeo_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    codigo VARCHAR(6) UNIQUE NOT NULL,
    departamento VARCHAR(100) NOT NULL,
    provincia VARCHAR(100) NOT NULL,
    distrito VARCHAR(100) NOT NULL,
    activo BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- PASO 3: Crear tabla clasificacion
CREATE TABLE IF NOT EXISTS clasificacion (
    clasificacion_id SERIAL PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    descripcion VARCHAR(255),
    activo BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- PASO 4: Crear tabla nivel_gobierno
CREATE TABLE IF NOT EXISTS nivel_gobierno (
    nivel_gobierno_id SERIAL PRIMARY KEY,
    nombre VARCHAR(50) UNIQUE NOT NULL,
    descripcion VARCHAR(200),
    activo BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- PASO 5: Crear tabla sector
CREATE TABLE IF NOT EXISTS sector (
    sector_id SERIAL PRIMARY KEY,
    nombre VARCHAR(100) UNIQUE NOT NULL,
    descripcion VARCHAR(200),
    activo BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- PASO 6: Eliminar y recrear tabla entidades con FK correctas
DROP TABLE IF EXISTS entidades CASCADE;

-- Crear tabla usuarios
CREATE TABLE usuarios (
    user_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(100) UNIQUE NOT NULL,
    num_dni VARCHAR(8) UNIQUE NOT NULL,
    nombres VARCHAR(100) NOT NULL,
    ape_paterno VARCHAR(60) NOT NULL,
    ape_materno VARCHAR(60) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    direccion VARCHAR(200),
    entidad_id UUID,
    perfil_id SMALLINT NOT NULL,
    activo BOOLEAN DEFAULT true,
    reset_password_token VARCHAR(100),
    reset_password_expiry TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- PASO 7: Crear tabla entidades con FK
CREATE TABLE entidades (
    entidad_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    ruc VARCHAR(11) UNIQUE NOT NULL,
    nombre VARCHAR(300) NOT NULL,
    direccion VARCHAR(200) NOT NULL,
    ubigeo_id UUID NOT NULL,
    nivel_gobierno_id INTEGER NOT NULL,
    telefono VARCHAR(20),
    email VARCHAR(100) NOT NULL,
    web VARCHAR(100),
    sector_id INTEGER NOT NULL,
    clasificacion_id INTEGER NOT NULL,
    nombre_alcalde VARCHAR(100) NOT NULL,
    ape_pat_alcalde VARCHAR(60) NOT NULL,
    ape_mat_alcalde VARCHAR(60) NOT NULL,
    email_alcalde VARCHAR(100) NOT NULL,
    activo BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_entidades_ubigeo FOREIGN KEY (ubigeo_id) REFERENCES ubigeo(ubigeo_id),
    CONSTRAINT fk_entidades_nivel_gobierno FOREIGN KEY (nivel_gobierno_id) REFERENCES nivel_gobierno(nivel_gobierno_id),
    CONSTRAINT fk_entidades_sector FOREIGN KEY (sector_id) REFERENCES sector(sector_id),
    CONSTRAINT fk_entidades_clasificacion FOREIGN KEY (clasificacion_id) REFERENCES clasificacion(clasificacion_id)
);

-- PASO 8: Eliminar y recrear tabla usuarios con FK correctas
DROP TABLE IF EXISTS usuarios CASCADE;

-- PASO 9: Crear tabla usuarios con FK
CREATE TABLE usuarios (
    user_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(200) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    num_dni VARCHAR(15) UNIQUE NOT NULL,
    nombres VARCHAR(100) NOT NULL,
    ape_paterno VARCHAR(60) NOT NULL,
    ape_materno VARCHAR(60) NOT NULL,
    direccion VARCHAR(200),
    entidad_id UUID,
    activo BOOLEAN NOT NULL DEFAULT true,
    perfil_id SMALLINT NOT NULL,
    last_login TIMESTAMP,
    reset_password_token VARCHAR(100),
    reset_password_expiry TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_usuarios_entidad FOREIGN KEY (entidad_id) REFERENCES entidades(entidad_id),
    CONSTRAINT fk_usuarios_perfil FOREIGN KEY (perfil_id) REFERENCES perfiles(perfil_id)
);

-- PASO 10: Crear Ã­ndices para optimizar consultas
CREATE INDEX IF NOT EXISTS idx_usuarios_email ON usuarios(email);
CREATE INDEX IF NOT EXISTS idx_usuarios_dni ON usuarios(num_dni);
CREATE INDEX IF NOT EXISTS idx_usuarios_perfil ON usuarios(perfil_id);
CREATE INDEX IF NOT EXISTS idx_usuarios_entidad ON usuarios(entidad_id);
CREATE INDEX IF NOT EXISTS idx_usuarios_last_login ON usuarios(last_login);
CREATE INDEX IF NOT EXISTS idx_usuarios_reset_token ON usuarios(reset_password_token);

CREATE INDEX IF NOT EXISTS idx_entidades_ruc ON entidades(ruc);
CREATE INDEX IF NOT EXISTS idx_entidades_ubigeo ON entidades(ubigeo_id);
CREATE INDEX IF NOT EXISTS idx_entidades_nivel_gobierno ON entidades(nivel_gobierno_id);
CREATE INDEX IF NOT EXISTS idx_entidades_sector ON entidades(sector_id);
CREATE INDEX IF NOT EXISTS idx_entidades_clasificacion ON entidades(clasificacion_id);

-- Foreign keys
ALTER TABLE usuarios 
    ADD CONSTRAINT fk_usuarios_entidad 
    FOREIGN KEY (entidad_id) REFERENCES entidades(entidad_id) ON DELETE SET NULL;

ALTER TABLE usuarios 
    ADD CONSTRAINT fk_usuarios_perfil 
    FOREIGN KEY (perfil_id) REFERENCES perfiles(perfil_id);

ALTER TABLE entidades 
    ADD CONSTRAINT fk_entidades_ubigeo 
    FOREIGN KEY (ubigeo_id) REFERENCES ubigeo(ubigeo_id);

ALTER TABLE entidades 
    ADD CONSTRAINT fk_entidades_nivel_gobierno 
    FOREIGN KEY (nivel_gobierno_id) REFERENCES nivel_gobierno(nivel_gobierno_id);

ALTER TABLE entidades 
    ADD CONSTRAINT fk_entidades_sector 
    FOREIGN KEY (sector_id) REFERENCES sector(sector_id);

ALTER TABLE entidades 
    ADD CONSTRAINT fk_entidades_clasificacion 
    FOREIGN KEY (clasificacion_id) REFERENCES clasificacion(clasificacion_id);

-- Insertar usuario admin de prueba (password: Admin123!)
-- Hash BCrypt de "Admin123!": $2a$11$vqE0rJ8bVvWYZYqk6SXxR.gKbAOXjnVe6.4t9LbKNnYGmhQGbVV6a
INSERT INTO usuarios (
    email, 
    num_dni, 
    nombres, 
    ape_paterno, 
    ape_materno, 
    password_hash,
    perfil_id,
    activo
) VALUES (
    'admin@pcm.gob.pe',
    '12345678',
    'Administrador',
    'Sistema',
    'PCM',
    '$2a$11$vqE0rJ8bVvWYZYqk6SXxR.gKbAOXjnVe6.4t9LbKNnYGmhQGbVV6a',
    1,
    true
) ON CONFLICT (email) DO NOTHING;

SELECT 'Tablas usuarios y entidades creadas exitosamente' AS status;
