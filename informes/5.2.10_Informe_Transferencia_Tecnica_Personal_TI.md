# 5.2.10 Informe de Transferencia TÃ©cnica

**INFORME TÃ‰CNICO**

**ASUNTO:** Informe de Transferencia TÃ©cnica: Infraestructura de Datos, Despliegue y Funcionamiento de MÃ³dulos â€“ Plataforma de Cumplimiento Digital (PCD)

**FECHA:** 30 de diciembre de 2025

**DIRIGIDO A:** Personal de TecnologÃ­as de la InformaciÃ³n - SGTD-PCM

**ELABORADO POR:** Equipo Consultor de Desarrollo

---

## 1. INTRODUCCIÃ“N Y ALCANCE

El presente documento detalla las actividades de transferencia tÃ©cnica correspondientes al **hito 5.2.10** de los TÃ©rminos de Referencia. Se describe el proceso de configuraciÃ³n, despliegue y puesta a punto de la arquitectura de persistencia de datos y lÃ³gica de negocio en los servidores de producciÃ³n de la PCM.

### 1.1 Objetivos del Documento

- Proporcionar un **manual de instalaciÃ³n** completo para el personal tÃ©cnico de TI
- Documentar la **configuraciÃ³n del archivo `appsettings.json`** y variables de entorno
- Detallar la **cadena de conexiÃ³n** a la base de datos
- Registrar las dificultades encontradas durante el proceso de despliegue
- Transferir el conocimiento tÃ©cnico necesario para la operaciÃ³n y mantenimiento del sistema

### 1.2 Material Complementario

> ğŸ“¹ **Video de Transferencia TÃ©cnica:** Se adjunta un video explicativo de aproximadamente 5 minutos donde se demuestra el proceso de despliegue de la plataforma, incluyendo la configuraciÃ³n de servicios y verificaciÃ³n de funcionamiento.

---

## 2. DIAGNÃ“STICO DE INFRAESTRUCTURA Y ADECUACIÃ“N TECNOLÃ“GICA

### 2.1 Discrepancia de Ambientes

Es fundamental precisar que, durante la fase de despliegue, el equipo consultor identificÃ³ una **discrepancia crÃ­tica** entre los ambientes proyectados y los ambientes finales asignados:

| Aspecto | Ambiente Proyectado (TDR) | Ambiente Asignado (Real) |
|---------|---------------------------|--------------------------|
| **Sistema Operativo** | Windows Server | Linux Ubuntu 24.04 LTS |
| **Arquitectura** | x86_64 | x86_64 |
| **Tipo de Instancia** | VM Windows | Instancia Linux |

### 2.2 Protocolo de AdecuaciÃ³n Ejecutado

Ante este escenario, se ejecutÃ³ un **protocolo de adecuaciÃ³n de infraestructura no contemplado originalmente**, que incluyÃ³:

| Actividad | DescripciÃ³n | Estado |
|-----------|-------------|--------|
| **Seguridad Perimetral** | ConfiguraciÃ³n de firewall UFW a nivel de Sistema Operativo | âœ… Completado |
| **GestiÃ³n de Acceso** | ConfiguraciÃ³n de permisos y llaves SSH para acceso seguro | âœ… Completado |
| **Dependencias** | InstalaciÃ³n manual de .NET 9 SDK, Node.js 20 LTS, Nginx | âœ… Completado |
| **OptimizaciÃ³n Kernel** | Ajustes para gestiÃ³n Ã³ptima de contenedores y servicios | âœ… Completado |

---

## 3. TRANSFERENCIA TÃ‰CNICA: CAPA DE PERSISTENCIA (DATABASE)

El componente central de la PCD reside en un motor de base de datos relacional robusto, configurado bajo estÃ¡ndares de alta disponibilidad y seguridad institucional.

### 3.1 Especificaciones del Motor de Base de Datos

| ParÃ¡metro | Valor |
|-----------|-------|
| **Software** | PostgreSQL v15.15 |
| **CompilaciÃ³n** | x86_64-pc-linux-gnu |
| **Host de ProducciÃ³n** | `101.44.10.71` |
| **Puerto de Servicio** | `5432` (TCP) |
| **Nombre de Base de Datos** | `pcd_plataforma` |
| **Encoding** | UTF-8 |
| **Collation** | es_PE.UTF-8 |

### 3.2 Cadena de ConexiÃ³n

```
Host=101.44.10.71;Port=5432;Database=pcd_plataforma;Username=postgres;Password=[CREDENCIAL_SEGURA]
```

> âš ï¸ **NOTA DE SEGURIDAD:** La contraseÃ±a real debe ser proporcionada por canales seguros y no debe ser almacenada en documentaciÃ³n pÃºblica.

### 3.3 Proceso de Hardening y ConfiguraciÃ³n de Acceso

Se han realizado ajustes crÃ­ticos en los archivos de configuraciÃ³n del motor para garantizar la **interoperabilidad a nivel nacional** solicitada en el TDR:

#### Archivo `postgresql.conf`
```conf
# Permitir conexiones desde endpoints externos (despuÃ©s de firewall)
listen_addresses = '*'

# ConfiguraciÃ³n de rendimiento
shared_buffers = 256MB
effective_cache_size = 768MB
maintenance_work_mem = 64MB
checkpoint_completion_target = 0.7
wal_buffers = 7864kB
default_statistics_target = 100
random_page_cost = 1.1
effective_io_concurrency = 200
work_mem = 1310kB
min_wal_size = 1GB
max_wal_size = 4GB
max_worker_processes = 4
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_parallel_maintenance_workers = 2
```

#### Archivo `pg_hba.conf`
```conf
# AutenticaciÃ³n local
local   all             postgres                                peer
local   all             all                                     peer

# AutenticaciÃ³n IPv4 (con contraseÃ±a cifrada)
host    all             all             127.0.0.1/32            scram-sha-256
host    all             all             0.0.0.0/0               scram-sha-256

# AutenticaciÃ³n IPv6
host    all             all             ::1/128                 scram-sha-256
```

### 3.4 Estructura de Datos (Schema) y MigraciÃ³n

Se completÃ³ la migraciÃ³n e importaciÃ³n de la estructura de datos, compuesta por **61 tablas relacionales** que soportan los siguientes mÃ³dulos:

| # | MÃ³dulo | Tablas Principales |
|---|--------|-------------------|
| 1 | **GestiÃ³n de Usuarios** | `usuarios`, `perfiles`, `perfil_permisos`, `permisos_modulos` |
| 2 | **GestiÃ³n de Entidades** | `entidades`, `sectores`, `niveles_gobierno`, `ubigeos` |
| 3 | **Marco Regulatorio** | `marcos_normativos`, `tipos_norma` |
| 4 | **GestiÃ³n de Compromisos** | `compromisos_gobierno_digital`, `compromiso_normativas`, `alcances_compromisos` |
| 5 | **Cumplimiento Normativo** | `cumplimientos_normativos`, `cumplimiento_historial`, `criterios_evaluacion` |
| 6 | **EvaluaciÃ³n & Cumplimiento** | `evaluacion_respuestas_entidad`, `ceda_evaluacion_cab`, `ceda_evaluacion_det` |
| 7 | **Compromisos EspecÃ­ficos** | `com1_lider_gtd` hasta `com21_oficial_gobierno_datos` |

El proceso de migraciÃ³n se realizÃ³ mediante:
```bash
# RestauraciÃ³n de backup
psql -h 101.44.10.71 -U postgres -d pcd_plataforma < backup_estructura.sql

# VerificaciÃ³n de integridad referencial
psql -h 101.44.10.71 -U postgres -d pcd_plataforma -c "SELECT count(*) FROM information_schema.tables WHERE table_schema = 'public';"
```

### 3.5 MÃ©todos de AdministraciÃ³n Transferidos

Se han validado **dos canales de acceso** para el equipo tÃ©cnico de la PCM:

#### OpciÃ³n 1: AdministraciÃ³n vÃ­a SSH Tunnel (Recomendado)
```bash
# Crear tÃºnel SSH seguro
ssh -L 5432:localhost:5432 usuario@101.44.10.71

# Conectar desde cliente local
psql -h localhost -p 5432 -U postgres -d pcd_plataforma
```

#### OpciÃ³n 2: ConexiÃ³n Directa con Cliente grÃ¡fico
- **DBeaver**: Configurar nueva conexiÃ³n PostgreSQL con los parÃ¡metros indicados
- **pgAdmin 4**: Agregar servidor con host, puerto y credenciales

---

## 4. MANUAL DE INSTALACIÃ“N

### 4.1 Requisitos del Sistema

| Componente | Requisito MÃ­nimo | Recomendado |
|------------|------------------|-------------|
| **Sistema Operativo** | Ubuntu 22.04 LTS | Ubuntu 24.04 LTS |
| **RAM** | 4 GB | 8 GB |
| **CPU** | 2 cores | 4 cores |
| **Almacenamiento** | 20 GB | 50 GB SSD |
| **Red** | 100 Mbps | 1 Gbps |

### 4.2 Dependencias de Software

| Software | VersiÃ³n | PropÃ³sito |
|----------|---------|-----------|
| **Docker** | 24.0+ | ContenedorizaciÃ³n del Backend |
| **Docker Compose** | 2.20+ | OrquestaciÃ³n de contenedores |
| **Node.js** | 20 LTS | Build del Frontend |
| **Nginx** | 1.24+ | Servidor Web / Reverse Proxy |
| **PostgreSQL Client** | 15+ | Herramientas de BD |
| **Git** | 2.40+ | Control de versiones |

### 4.3 InstalaciÃ³n Paso a Paso

#### Paso 1: Actualizar Sistema e Instalar Dependencias BÃ¡sicas

```bash
# Actualizar sistema
sudo apt update && sudo apt upgrade -y

# Instalar dependencias bÃ¡sicas
sudo apt install -y \
    curl \
    wget \
    git \
    unzip \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release \
    software-properties-common \
    build-essential
```

#### Paso 2: Instalar Docker y Docker Compose

```bash
# Instalar Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Agregar usuario actual al grupo docker
sudo usermod -aG docker $USER

# Instalar Docker Compose (plugin)
sudo apt install -y docker-compose-plugin

# Verificar instalaciÃ³n
docker --version
# Debe mostrar: Docker version 24.x.x

docker compose version
# Debe mostrar: Docker Compose version v2.x.x

# Habilitar Docker para inicio automÃ¡tico
sudo systemctl enable docker
sudo systemctl start docker
```

> âš ï¸ **NOTA:** DespuÃ©s de agregar el usuario al grupo docker, debe cerrar sesiÃ³n y volver a iniciar para que los cambios surtan efecto.

#### Paso 3: Instalar Node.js 20 LTS

```bash
# Instalar NodeSource repository
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# Verificar instalaciÃ³n
node --version  # v20.x.x
npm --version   # 10.x.x
```

#### Paso 4: Instalar y Configurar Nginx

```bash
# Instalar Nginx
sudo apt install -y nginx

# Habilitar e iniciar servicio
sudo systemctl enable nginx
sudo systemctl start nginx

# Verificar estado
sudo systemctl status nginx
```

#### Paso 5: Crear Estructura de Directorios

```bash
# Crear directorios de la aplicaciÃ³n
sudo mkdir -p /var/www/pcm/{source,backend/publish,frontend/dist,logs}

# Asignar permisos
sudo chown -R $USER:$USER /var/www/pcm
sudo chmod -R 755 /var/www/pcm
```

#### Paso 6: Clonar Repositorio

```bash
cd /var/www/pcm

# Clonar repositorio (requiere credenciales de GitHub)
git clone https://github.com/[REPOSITORIO_INSTITUCIONAL]/pcm.git source

# Verificar clonaciÃ³n
ls -la source/
```

#### Paso 7: Compilar Backend (.NET)

```bash
cd /var/www/pcm/source/backend

# Restaurar paquetes NuGet
dotnet restore

# Publicar en modo Release
dotnet publish PCM.API/PCM.API.csproj -c Release -o /var/www/pcm/backend/publish

# Verificar publicaciÃ³n
ls -la /var/www/pcm/backend/publish/
# Debe existir: PCM.API.dll
```

#### Paso 8: Compilar Frontend (React)

```bash
cd /var/www/pcm/source/frontend

# Instalar dependencias npm
npm ci

# Crear archivo de configuraciÃ³n de producciÃ³n
cat > .env.production << 'EOF'
VITE_API_URL=/api
VITE_RECAPTCHA_SITE_KEY=6Lc2mgEsAAAAABvNtpyQFMzwSfgCsGXgFFD8SR4Y
VITE_ENVIRONMENT=production
EOF

# Build de producciÃ³n
npm run build

# Copiar a directorio de distribuciÃ³n
cp -r dist/* /var/www/pcm/frontend/dist/
```

---

## 5. CONFIGURACIÃ“N DEL ARCHIVO `appsettings.json`

### 5.1 UbicaciÃ³n del Archivo

```
/var/www/pcm/backend/publish/appsettings.json
```

### 5.2 Estructura Completa del Archivo

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  
  "ConnectionStrings": {
    "DefaultConnection": "Host=101.44.10.71;Port=5432;Database=pcd_plataforma;Username=postgres;Password=[CONTRASEÃ‘A_SEGURA]"
  },
  
  "JwtSettings": {
    "SecretKey": "[CLAVE_JWT_MINIMO_32_CARACTERES]",
    "Issuer": "PCM.API",
    "Audience": "PCM.Client",
    "ExpirationMinutes": 60,
    "RefreshTokenExpirationDays": 7
  },
  
  "ReCaptcha": {
    "SecretKey": "[CLAVE_SECRETA_RECAPTCHA]",
    "VerifyUrl": "https://www.google.com/recaptcha/api/siteverify",
    "MinScore": 0.5
  },
  
  "Aws": {
    "AccessKeyId": "AKIA4TCYZV3ZROYMAUWM",
    "SecretAccessKey": "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",
    "Region": "us-east-1",
    "SesFromEmail": "notificaciones@plataformacumplimientodigital.servicios.gob.pe",
    "SesFromName": "Plataforma de Cumplimiento Digital - PCM",
    "FrontendUrl": "https://[DOMINIO_PRODUCCION]"
  },
  
  "Cors": {
    "Origins": [
      "https://[DOMINIO_PRODUCCION]",
      "http://localhost:5173"
    ]
  },
  
  "FileStorage": {
    "BasePath": "/var/www/pcm/storage",
    "MaxFileSizeMB": 10,
    "AllowedExtensions": [".pdf", ".jpg", ".jpeg", ".png"]
  },
  
  "FrontendUrl": "https://[DOMINIO_PRODUCCION]"
}
```

### 5.3 DescripciÃ³n de ParÃ¡metros CrÃ­ticos

| SecciÃ³n | ParÃ¡metro | DescripciÃ³n | Obligatorio |
|---------|-----------|-------------|-------------|
| **ConnectionStrings** | `DefaultConnection` | Cadena de conexiÃ³n a PostgreSQL | âœ… SÃ­ |
| **JwtSettings** | `SecretKey` | Clave para firmar tokens JWT (mÃ­n. 32 chars) | âœ… SÃ­ |
| **JwtSettings** | `ExpirationMinutes` | Tiempo de vida del token en minutos | âœ… SÃ­ |
| **ReCaptcha** | `SecretKey` | Clave secreta de Google reCAPTCHA v3 | âš ï¸ Recomendado |
| **Aws** | `AccessKeyId`, `SecretAccessKey` | Credenciales AWS SES para envÃ­o de correos | âœ… Configurado |
| **Aws** | `SesFromEmail` | Email verificado en AWS SES | âœ… Configurado |
| **FileStorage** | `BasePath` | Ruta local para almacenamiento de archivos | âœ… SÃ­ |
| **Cors** | `Origins` | Dominios permitidos para CORS | âœ… SÃ­ |

### 5.4 ConfiguraciÃ³n Alternativa: Variables de Entorno

En lugar de modificar `appsettings.json`, se pueden usar **variables de entorno** (recomendado para producciÃ³n):

```bash
# Crear archivo .env
cat > /var/www/pcm/backend/.env << 'EOF'
# ============================================
# PCM Backend - Variables de Entorno
# ============================================

ASPNETCORE_ENVIRONMENT=Production
ASPNETCORE_URLS=http://0.0.0.0:5000

# Base de Datos PostgreSQL
ConnectionStrings__DefaultConnection=Host=101.44.10.71;Port=5432;Database=pcd_plataforma;Username=postgres;Password=[CONTRASEÃ‘A]

# JWT Authentication
JwtSettings__SecretKey=[CLAVE_SECRETA_32_CARACTERES_MINIMO]
JwtSettings__Issuer=PCM.API
JwtSettings__Audience=PCM.Client
JwtSettings__ExpirationMinutes=60
JwtSettings__RefreshTokenExpirationDays=7

# Google reCAPTCHA v3
ReCaptcha__SecretKey=[CLAVE_RECAPTCHA]

# AWS SES (Amazon Simple Email Service)
Aws__AccessKeyId=AKIA4TCYZV3ZROYMAUWM
Aws__SecretAccessKey=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
Aws__Region=us-east-1
Aws__SesFromEmail=notificaciones@plataformacumplimientodigital.servicios.gob.pe
Aws__SesFromName=Plataforma de Cumplimiento Digital - PCM
Aws__FrontendUrl=https://[DOMINIO_PRODUCCION]

# Almacenamiento de Archivos (Local en el Host)
FileStorage__BasePath=/var/www/pcm/storage
FileStorage__MaxFileSizeMB=10

# CORS
Cors__Origins__0=https://[DOMINIO_PRODUCCION]

# URL del Frontend
FrontendUrl=https://[DOMINIO_PRODUCCION]

# Logging
Logging__LogLevel__Default=Information
EOF
```

---

## 6. DESPLIEGUE CON DOCKER

### 6.1 Arquitectura de Contenedores

La plataforma se despliega mediante **Docker** con una arquitectura multi-contenedor que incluye:

- **Backend API** (.NET 9) en contenedor aislado
- **Frontend** (React + Nginx) en contenedor separado
- **Base de Datos PostgreSQL** externa (101.44.10.71:5432)
- **Almacenamiento Local** mediante volÃºmenes Docker

### 6.2 Dockerfile del Backend

El archivo `Dockerfile.local` (para producciÃ³n) incluye compilaciÃ³n multi-etapa optimizada:

```dockerfile
# ============================================
# Dockerfile para Backend - ProducciÃ³n
# Multi-stage build para optimizar tamaÃ±o
# ============================================

# Etapa 1: Build
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /src

# Copiar archivos de proyecto y restaurar dependencias
COPY backend/PCM.Domain/*.csproj ./backend/PCM.Domain/
COPY backend/PCM.Application/*.csproj ./backend/PCM.Application/
COPY backend/PCM.Infrastructure/*.csproj ./backend/PCM.Infrastructure/
COPY backend/PCM.Shared/*.csproj ./backend/PCM.Shared/
COPY backend/PCM.API/*.csproj ./backend/PCM.API/
RUN dotnet restore backend/PCM.API/PCM.API.csproj

# Copiar cÃ³digo fuente y compilar
COPY backend/ ./backend/
WORKDIR /src/backend/PCM.API
RUN dotnet clean && dotnet publish -c Release -o /app/publish --no-restore

# Etapa 2: Runtime
FROM mcr.microsoft.com/dotnet/aspnet:9.0
WORKDIR /app

# Copiar binarios compilados
COPY --from=build /app/publish .

# Crear directorios para almacenamiento
RUN mkdir -p /app/storage/documentos && \
    chmod 755 /app/storage && \
    chmod 755 /app/storage/documentos

# Configurar healthcheck
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:5164/health || exit 1

# Exponer puerto
EXPOSE 5164

# Variables de entorno por defecto
ENV ASPNETCORE_ENVIRONMENT=Docker
ENV ASPNETCORE_URLS=http://+:5164

# Comando de inicio
ENTRYPOINT ["dotnet", "PCM.API.dll"]
```

### 6.3 Dockerfile del Frontend

El archivo `frontend/Dockerfile` incluye compilaciÃ³n de React y servicio con Nginx:

```dockerfile
# ============================================
# Dockerfile para Frontend - Multi-arquitectura
# ============================================

# Etapa 1: Build de React
FROM node:20-alpine AS build

WORKDIR /app

# Argumentos de build para variables de entorno
ARG VITE_API_URL=http://localhost:5164/api
ARG VITE_RECAPTCHA_SITE_KEY=6Lc2mgEsAAAAAMAsjyD9M0MsqCJxpYHS0-prSm9J

# Establecer como variables de entorno para el build
ENV VITE_API_URL=$VITE_API_URL
ENV VITE_RECAPTCHA_SITE_KEY=$VITE_RECAPTCHA_SITE_KEY

# Instalar dependencias
COPY package*.json ./
RUN npm ci

# Copiar cÃ³digo y compilar
COPY . .
RUN npm run build

# Etapa 2: Servir con Nginx
FROM nginx:alpine

# Copiar build al directorio de nginx
COPY --from=build /app/dist /usr/share/nginx/html

# Copiar configuraciÃ³n personalizada de nginx
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Exponer puerto 80
EXPOSE 80

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD wget --quiet --tries=1 --spider http://localhost/ || exit 1

# Comando de inicio
CMD ["nginx", "-g", "daemon off;"]
```

### 6.4 Docker Compose para Servidor del Cliente

Se han creado **dos configuraciones** de Docker Compose:

#### A. ConfiguraciÃ³n Local (Pruebas - `docker-compose.local.yml`)

```yaml
version: '3.8'

services:
  # Backend API (.NET 9)
  backend:
    build:
      context: .
      dockerfile: Dockerfile.local
    container_name: pcm-backend-local
    restart: unless-stopped
    ports:
      - "5164:5164"
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:5164
    volumes:
      - storage_data:/app/storage
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - pcm-network

  # Frontend (React + Nginx)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=http://localhost:5164/api
        - VITE_RECAPTCHA_SITE_KEY=6Lc2mgEsAAAAAMAsjyD9M0MsqCJxpYHS0-prSm9J
    container_name: pcm-frontend-local
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      - backend
    networks:
      - pcm-network

volumes:
  storage_data:
    driver: local

networks:
  pcm-network:
    driver: bridge
```

#### B. ConfiguraciÃ³n Servidor Linux x86_64 (`docker-compose.server.yml`)

```yaml
version: '3.8'

services:
  # Backend API (.NET 9)
  backend:
    platform: linux/amd64  # Forzar arquitectura x86_64
    build:
      context: .
      dockerfile: Dockerfile.local
      platforms:
        - linux/amd64
    container_name: pcm-backend-server
    restart: unless-stopped
    ports:
      - "5164:5164"
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:5164
    volumes:
      - storage_data:/app/storage
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - pcm-network

  # Frontend (React + Vite + Nginx)
  frontend:
    platform: linux/amd64  # Forzar arquitectura x86_64
    build:
      context: ./frontend
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
      args:
        - VITE_API_URL=http://101.44.10.71:5164/api
        - VITE_RECAPTCHA_SITE_KEY=6Lc2mgEsAAAAAMAsjyD9M0MsqCJxpYHS0-prSm9J
    container_name: pcm-frontend-server
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      - backend
    networks:
      - pcm-network

volumes:
  storage_data:
    driver: local

networks:
  pcm-network:
    driver: bridge
```

### 6.5 Script Automatizado de Despliegue

Se ha creado el script `start-server-docker.sh` que automatiza todo el proceso de despliegue:

**Paso 1:** Conectar al servidor y clonar el repositorio

```bash
ssh usuario@101.44.10.71
cd /opt
sudo git clone https://github.com/miguelgargurevich/pcm.git
cd pcm
sudo chown -R $USER:$USER /opt/pcm
```

**Paso 2:** Ejecutar el script de despliegue

```bash
chmod +x start-server-docker.sh
./start-server-docker.sh
```

El script realizarÃ¡ automÃ¡ticamente:
- âœ… VerificaciÃ³n de Docker y Docker Compose
- âœ… DetecciÃ³n de arquitectura del sistema
- âœ… ValidaciÃ³n de conectividad a PostgreSQL
- âœ… ConstrucciÃ³n de imÃ¡genes Docker para arquitectura amd64
- âœ… Levantamiento de contenedores
- âœ… VerificaciÃ³n de health checks
- âœ… Despliegue de ambos servicios (backend y frontend)

**Paso 3:** Verificar el despliegue

```bash
# Ver contenedores corriendo
docker ps

# Verificar health check del backend
curl http://localhost:5164/health

# Ver logs del backend
docker logs pcm-backend-server -f

# Ver logs del frontend
docker logs pcm-frontend-server -f
```

### 6.6 DocumentaciÃ³n Complementaria Creada

Se han creado los siguientes documentos tÃ©cnicos en el repositorio:

| Documento | UbicaciÃ³n | DescripciÃ³n |
|-----------|-----------|-------------|
| **DESPLIEGUE_SERVIDOR_CLIENTE.md** | `/` | GuÃ­a completa de despliegue paso a paso con troubleshooting |
| **TRANSFERENCIA_SERVIDOR.md** | `/` | Opciones para transferir el proyecto al servidor (SCP, Git, rsync) |
| **FRONTEND_SERVIDOR.md** | `/` | ConfiguraciÃ³n especÃ­fica del frontend y verificaciones |
| **DOCKER_LOCAL_README.md** | `/docs/` | GuÃ­a para pruebas locales con Docker |
| **start-server-docker.sh** | `/` | Script automatizado de despliegue |

### 6.7 Pruebas de Despliegue Realizadas

#### Prueba 1: ConstrucciÃ³n Multi-Arquitectura

âœ… **Resultado:** Exitoso
- **Backend**: Compilado en 103.7 segundos para `linux/amd64`
- **Frontend**: Compilado en 20.6 segundos con variables de entorno embebidas
- **Arquitectura**: `platform: linux/amd64` especificado en docker-compose
- **ImÃ¡genes**: Construidas correctamente desde mÃ¡quina ARM64 (Mac M1/M2)

#### Prueba 2: Health Check y Conectividad

âœ… **Resultado:** Exitoso
```json
{
  "status": "healthy",
  "timestamp": "2025-12-30T21:30:54.4742811Z",
  "database": "connected",
  "environment": "Docker"
}
```

#### Prueba 3: AutenticaciÃ³n JWT

âœ… **Resultado:** Exitoso
- Login endpoint funcionando correctamente
- JWT token generado exitosamente
- RefreshToken generado y almacenado
- Usuario de prueba verificado: `admin.test@pcm.gob.pe`
- ContraseÃ±a validada: `Admin123!`

#### Prueba 4: Frontend Build y Variables de Entorno

âœ… **Resultado:** Exitoso
- URL del API correctamente embebida en el bundle JavaScript
- Verificado en archivos compilados: `http://101.44.10.71:5164/api`
- Build ARG variables aplicadas correctamente durante la compilaciÃ³n
- Nginx sirviendo aplicaciÃ³n en puerto 3000 â†’ 80

#### Prueba 5: Almacenamiento Local

âœ… **Resultado:** Exitoso
```bash
$ docker exec pcm-backend-server ls -la /app/storage/
drwxr-xr-x 3 root root 4096 /app/storage/
drwxr-xr-x 2 root root 4096 /app/storage/documentos
```
- Volumen Docker `storage_data` montado correctamente
- Permisos de escritura configurados (755)
- Directorio `/app/storage/documentos` creado automÃ¡ticamente

### 6.8 Credenciales de Acceso para Pruebas

| Perfil | Email | ContraseÃ±a | DescripciÃ³n |
|--------|-------|------------|-------------|
| **Administrador PCM** | admin.test@pcm.gob.pe | Admin123! | Acceso completo al sistema |
| **Entidad** | entidad.test@gob.pe | Admin123! | Registro de compromisos |
| **Operador PCM** | operador.test@pcm.gob.pe | Admin123! | Seguimiento y evaluaciÃ³n |

> ğŸ“š **Nota:** Ver archivo `docs/USUARIOS_PRUEBA.md` para la lista completa de usuarios de prueba

### 6.9 Arquitectura de Contenedores Desplegada

# Etapa 2: Servir con Nginx
FROM nginx:alpine

# Copiar build al directorio de nginx
COPY --from=build /app/dist /usr/share/nginx/html

# Copiar configuraciÃ³n personalizada de nginx
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Exponer puerto 80
EXPOSE 80

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD wget --quiet --tries=1 --spider http://localhost/ || exit 1

# Comando de inicio
CMD ["nginx", "-g", "daemon off;"]
```

### 6.4 Docker Compose para Servidor del Cliente

Se han creado **dos configuraciones** de Docker Compose:

#### A. ConfiguraciÃ³n Local (Pruebas - `docker-compose.local.yml`)

```yaml
version: '3.8'

services:
  # Backend API (.NET 9)
  backend:
    build:
      context: .
      dockerfile: Dockerfile.local
    container_name: pcm-backend-local
    restart: unless-stopped
    ports:
      - "5164:5164"
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:5164
    volumes:
      - storage_data:/app/storage
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - pcm-network

  # Frontend (React + Nginx)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=http://localhost:5164/api
        - VITE_RECAPTCHA_SITE_KEY=6Lc2mgEsAAAAAMAsjyD9M0MsqCJxpYHS0-prSm9J
    container_name: pcm-frontend-local
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      - backend
    networks:
      - pcm-network

volumes:
  storage_data:
    driver: local

networks:
  pcm-network:
    driver: bridge
```

#### B. ConfiguraciÃ³n Servidor Linux x86_64 (`docker-compose.server.yml`)

```yaml
version: '3.8'

services:
  # Backend API (.NET 9)
  backend:
    platform: linux/amd64  # Forzar arquitectura x86_64
    build:
      context: .
      dockerfile: Dockerfile.local
      platforms:
        - linux/amd64
    container_name: pcm-backend-server
    restart: unless-stopped
    ports:
      - "5164:5164"
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:5164
    volumes:
      - storage_data:/app/storage
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - pcm-network

  # Frontend (React + Vite + Nginx)
  frontend:
    platform: linux/amd64  # Forzar arquitectura x86_64
    build:
      context: ./frontend
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
      args:
        - VITE_API_URL=http://101.44.10.71:5164/api
        - VITE_RECAPTCHA_SITE_KEY=6Lc2mgEsAAAAAMAsjyD9M0MsqCJxpYHS0-prSm9J
    container_name: pcm-frontend-server
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      - backend
    networks:
      - pcm-network

volumes:
  storage_data:
    driver: local

networks:
  pcm-network:
    driver: bridge
```

### 6.5 Script Automatizado de Despliegue

Se ha creado el script `start-server-docker.sh` que automatiza todo el proceso:

```bash
#!/bin/bash
# Script de Inicio para Servidor Linux del Cliente
# Arquitectura: x86_64/amd64

set -e  # Salir si hay error

echo "================================================"
echo "ğŸš€ Iniciando PCM en Servidor Linux"
echo "================================================"

# 1. Verificar Docker
echo "ğŸ“‹ Verificando Docker..."
if ! docker info > /dev/null 2>&1; then
    echo "âŒ Docker no estÃ¡ corriendo"
    exit 1
fi

# 2. Verificar arquitectura
echo "ğŸ“‹ Verificando arquitectura..."
ARCH=$(uname -m)
echo "Arquitectura detectada: $ARCH"

# 3. Verificar conectividad a PostgreSQL
echo "ğŸ“‹ Verificando conectividad a PostgreSQL..."
DB_HOST="101.44.10.71"
DB_PORT="5432"

if nc -zv $DB_HOST $DB_PORT 2>&1 | grep -q "succeeded\|open"; then
    echo "âœ… ConexiÃ³n a PostgreSQL disponible"
else
    echo "âš ï¸ No se puede conectar a PostgreSQL"
fi

# 4. Construir y levantar contenedores
echo "ğŸ—ï¸ Construyendo imÃ¡genes Docker..."
docker compose -f docker-compose.server.yml up -d --build

# 5. Esperar que los servicios estÃ©n listos
echo "â³ Esperando que los servicios estÃ©n listos..."
sleep 5

# 6. Verificar health check
for i in {1..30}; do
    if curl -s http://localhost:5164/health > /dev/null 2>&1; then
        echo "âœ… Backend estÃ¡ respondiendo"
        break
    fi
    sleep 2
done

# 7. Mostrar informaciÃ³n de acceso
SERVER_IP=$(hostname -I | awk '{print $1}')
echo "================================================"
echo "âœ… Despliegue Completado"
echo "================================================"
echo ""
echo "ğŸŒ URLs de Acceso:"
echo "   - Frontend:     http://$SERVER_IP:3000"
echo "   - Backend API:  http://$SERVER_IP:5164"
echo "   - Health Check: http://$SERVER_IP:5164/health"
echo ""
echo "ğŸ‘¤ Credenciales de Prueba:"
echo "   - Usuario: admin.test@pcm.gob.pe"
echo "   - Password: Admin123!"
```

### 6.6 Proceso de Despliegue en Servidor del Cliente

```yaml
version: '3.8'

services:
  pcm-backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pcm-backend
    restart: always
    ports:
      - "5000:5000"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://0.0.0.0:5000
      # Base de Datos
      - ConnectionStrings__DefaultConnection=Host=101.44.10.71;Port=5432;Database=pcd_plataforma;Username=postgres;Password=[CONTRASEÃ‘A]
      # JWT
      - JwtSettings__SecretKey=[CLAVE_JWT_32_CARACTERES]
      - JwtSettings__Issuer=PCM.API
      - JwtSettings__Audience=PCM.Client
      - JwtSettings__ExpirationMinutes=60
      - JwtSettings__RefreshTokenExpirationDays=7
      # SMTP Institucional (Credenciales PCM)
      - Smtp__Host=[SERVIDOR_SMTP_PCM]
      - Smtp__Port=587
      - Smtp__Username=[USUARIO_SMTP]
      - Smtp__Password=[CONTRASEÃ‘A_SMTP]
      - Smtp__FromEmail=notificaciones@pcm.gob.pe
      - Smtp__FromName=Plataforma de Cumplimiento Digital
      - Smtp__EnableSsl=true
      # Almacenamiento Local
      - FileStorage__BasePath=/app/storage
      - FileStorage__MaxFileSizeMB=10
      # reCAPTCHA
      - ReCaptcha__SecretKey=[CLAVE_RECAPTCHA]
      # CORS
      - Cors__Origins__0=https://[DOMINIO_PRODUCCION]
      # Frontend URL
      - FrontendUrl=https://[DOMINIO_PRODUCCION]
    volumes:
      # Persistir archivos subidos (PDFs, evidencias)
      - /var/www/pcm/storage:/app/storage
      # Logs
      - /var/www/pcm/logs:/app/logs
    networks:
      - pcm-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  pcm-network:
    driver: bridge
```

### 6.3 Comandos de Despliegue con Docker

```bash
# Crear directorios para volÃºmenes
sudo mkdir -p /var/www/pcm/{storage,logs,frontend/dist}
sudo chown -R $USER:$USER /var/www/pcm

# Clonar repositorio (si no existe)
cd /var/www/pcm
git clone https://github.com/[REPOSITORIO]/pcm.git source
cd source

# Construir imagen Docker
docker compose -f docker-compose.prod.yml build

# Iniciar contenedor en modo detached
docker compose -f docker-compose.prod.yml up -d

# Verificar que el contenedor estÃ¡ corriendo
docker ps

# Ver logs del contenedor
docker logs -f pcm-backend
```

### 6.4 Estructura de Directorios con Docker

```
/var/www/pcm/
â”œâ”€â”€ source/                      # CÃ³digo fuente (git clone)
â”‚   â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ docker-compose.prod.yml
â”œâ”€â”€ storage/                     # Volumen: Archivos subidos (PDFs)
â”‚   â”œâ”€â”€ evidencias/
â”‚   â””â”€â”€ documentos/
â”œâ”€â”€ logs/                        # Volumen: Logs de la aplicaciÃ³n
â”‚   â”œâ”€â”€ backend-*.log
â”‚   â””â”€â”€ nginx-*.log
â””â”€â”€ frontend/
    â””â”€â”€ dist/                    # React build (archivos estÃ¡ticos)
```

### 6.5 ConfiguraciÃ³n de Nginx

Crear archivo `/etc/nginx/sites-available/pcm`:

```nginx
server {
    listen 80;
    server_name [DOMINIO_O_IP];

    # Logs
    access_log /var/www/pcm/logs/nginx-access.log;
    error_log /var/www/pcm/logs/nginx-error.log;

    # TamaÃ±o mÃ¡ximo de upload (para PDFs)
    client_max_body_size 50M;

    # Frontend - React SPA
    location / {
        root /var/www/pcm/frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;

        # Cache para assets estÃ¡ticos
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # Backend API - Reverse Proxy
    location /api/ {
        proxy_pass http://127.0.0.1:5000/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection keep-alive;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Swagger Documentation
    location /swagger {
        proxy_pass http://127.0.0.1:5000/swagger;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 6.7 Activar ConfiguraciÃ³n Nginx

```bash
# Crear enlace simbÃ³lico
sudo ln -s /etc/nginx/sites-available/pcm /etc/nginx/sites-enabled/

# Eliminar configuraciÃ³n default (opcional)
sudo rm /etc/nginx/sites-enabled/default

# Verificar configuraciÃ³n
sudo nginx -t

# Recargar Nginx
sudo systemctl reload nginx
```

---

## 7. FUNCIONAMIENTO DE LOS MÃ“DULOS (LÃ“GICA DE NEGOCIO)

### 7.1 Arquitectura de Servicios con Docker

El despliegue de los mÃ³dulos sigue una **arquitectura orientada a contenedores**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLIENTE (Browser)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ HTTPS/HTTP
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         NGINX (Puerto 80/443)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Frontend React (/)     â”‚  â”‚  Reverse Proxy (/api)       â”‚   â”‚
â”‚  â”‚  Archivos estÃ¡ticos     â”‚  â”‚  â†’ Docker Container :5000   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DOCKER CONTAINER: pcm-backend                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  .NET 9 Runtime + PCM.API.dll                           â”‚    â”‚
â”‚  â”‚  Controllers â†’ Services â†’ Handlers â†’ DbContext          â”‚    â”‚
â”‚  â”‚  (MediatR CQRS Pattern)                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  VolÃºmenes Montados:                                    â”‚    â”‚
â”‚  â”‚  â€¢ /var/www/pcm/storage â†’ /app/storage (PDFs)           â”‚    â”‚
â”‚  â”‚  â€¢ /var/www/pcm/logs â†’ /app/logs                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ Npgsql Driver
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   PostgreSQL 15 (Puerto 5432)                    â”‚
â”‚                   Host: 101.44.10.71                             â”‚
â”‚                   Base de Datos: pcd_plataforma                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               AWS SES (Amazon Simple Email Service)              â”‚
â”‚               Region: us-east-1                                  â”‚
â”‚               Dominio: plataformacumplimientodigital.servicios.gob.pe â”‚
â”‚               â€¢ Notificaciones de cumplimiento                   â”‚
â”‚               â€¢ RecuperaciÃ³n de contraseÃ±a                       â”‚
â”‚               â€¢ Alertas del sistema                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 Componentes TÃ©cnicos

| Componente | TecnologÃ­a | DescripciÃ³n |
|------------|------------|-------------|
| **Contenedor** | Docker | Aislamiento y portabilidad |
| **Backend Runtime** | .NET 9.0 | Entorno de ejecuciÃ³n de la API |
| **ORM** | Entity Framework Core 9.0 | Mapeo objeto-relacional |
| **Driver PostgreSQL** | Npgsql 9.0.4 | ComunicaciÃ³n con la base de datos |
| **AutenticaciÃ³n** | JWT Bearer | Tokens de acceso seguros |
| **ValidaciÃ³n** | FluentValidation | ValidaciÃ³n de datos de entrada |
| **DocumentaciÃ³n API** | Swagger/OpenAPI | DocumentaciÃ³n interactiva |

### 7.3 Seguridad de Capa

- **AutenticaciÃ³n JWT**: Cada request a endpoints protegidos requiere token vÃ¡lido
- **AutorizaciÃ³n RBAC**: Control de acceso basado en roles (Admin, Operador, Entidad)
- **ValidaciÃ³n de Entrada**: FluentValidation previene inyecciÃ³n de datos maliciosos
- **Queries Parametrizadas**: Entity Framework previene SQL Injection
- **CORS Configurado**: Solo dominios autorizados pueden consumir la API

---

## 8. DIFICULTADES ENCONTRADAS Y PENDIENTES

### 8.1 Dificultades TÃ©cnicas Resueltas

| # | Dificultad | Impacto | SoluciÃ³n Implementada |
|---|------------|---------|----------------------|
| 1 | **Cambio de SO** (Windows â†’ Linux) | Alto | ReconfiguraciÃ³n completa de scripts de despliegue y uso de Docker |
| 2 | **ConfiguraciÃ³n SSH** sin documentaciÃ³n previa | Medio | GeneraciÃ³n de llaves y configuraciÃ³n de acceso |
| 3 | **Permisos de firewall** no documentados | Medio | Apertura de puertos 80, 443, 5432 en UFW |
| 4 | **Falta de certificado SSL** | Medio | Pendiente - se configurÃ³ HTTP temporal |
| 5 | **AdaptaciÃ³n a Docker** | Medio | CreaciÃ³n de Dockerfile y docker-compose para producciÃ³n |

### 8.2 Dependencias Pendientes de la SGTD-PCM

Para la **culminaciÃ³n del despliegue final** y funcionamiento completo de la plataforma, se requiere que la SGTD-PCM provea los siguientes parÃ¡metros tÃ©cnicos:

| # | Requerimiento | DescripciÃ³n | Formato Esperado | Estado | Responsable |
|---|---------------|-------------|------------------|--------|-------------|
| 1 | **AWS SES Email Service** | Servicio de correo AWS SES configurado | Credenciales AWS + Dominio verificado | âœ… Completado | PCM |
| 2 | **Certificado SSL** | Certificado para habilitar HTTPS en producciÃ³n | Archivos `.crt` y `.key` | ğŸ”´ Pendiente | SGTD |
| 3 | **Dominio de ProducciÃ³n** | DNS institucional para la plataforma | `cumplimiento.pcm.gob.pe` | ğŸ”´ Pendiente | SGTD |
| 4 | **Credenciales de Repositorio** | Acceso al repositorio institucional de cÃ³digo fuente | URL Git + token/credenciales | ğŸ”´ Pendiente | SGTD |

> **NOTA:** El almacenamiento de archivos (PDFs, evidencias) se realizarÃ¡ localmente en el servidor host mediante volÃºmenes Docker, por lo que solo se requiere definir la ruta base y asegurar permisos de escritura. La ruta predeterminada configurada es `/var/www/pcm/storage`.

### 8.3 ConfiguraciÃ³n de AWS SES Implementada

El servicio de correo electrÃ³nico ha sido configurado usando **AWS SES (Amazon Simple Email Service)** con las siguientes credenciales:

```
Aws__AccessKeyId=AKIA4TCYZV3ZROYMAUWM
Aws__SecretAccessKey=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
Aws__Region=us-east-1
Aws__SesFromEmail=notificaciones@plataformacumplimientodigital.servicios.gob.pe
Aws__SesFromName=Plataforma de Cumplimiento Digital - PCM
```

**Dominio verificado en AWS SES:** `plataformacumplimientodigital.servicios.gob.pe`

### 8.4 Impacto de Pendientes

| Funcionalidad Afectada | Dependencia Requerida | Criticidad | Estado |
|------------------------|----------------------|------------|--------|
| Notificaciones por email | AWS SES | ğŸ”´ Alta | âœ… Completado |
| RecuperaciÃ³n de contraseÃ±a | AWS SES | ğŸ”´ Alta | âœ… Completado |
| ConexiÃ³n segura HTTPS | Certificado SSL | ğŸŸ¡ Media | ğŸ”´ Pendiente |
| URL de producciÃ³n final | Dominio institucional | ğŸŸ¡ Media | ğŸ”´ Pendiente |

---

## 9. COMANDOS ÃšTILES DE ADMINISTRACIÃ“N

### 9.1 GestiÃ³n del Contenedor Docker

```bash
# Ver contenedores en ejecuciÃ³n
docker ps

# Ver logs del backend en tiempo real
docker logs -f pcm-backend

# Reiniciar contenedor del backend
docker restart pcm-backend

# Detener contenedor
docker stop pcm-backend

# Iniciar contenedor
docker start pcm-backend

# Ver uso de recursos del contenedor
docker stats pcm-backend

# Acceder al shell del contenedor (para debugging)
docker exec -it pcm-backend /bin/bash

# Ver archivos en el storage del contenedor
docker exec pcm-backend ls -la /app/storage
```

### 9.2 GestiÃ³n de Nginx

```bash
# Ver estado de Nginx
sudo systemctl status nginx

# Reiniciar Nginx
sudo systemctl reload nginx

# Ver logs de Nginx
sudo tail -f /var/www/pcm/logs/nginx-error.log
sudo tail -f /var/www/pcm/logs/nginx-access.log

# Verificar configuraciÃ³n
sudo nginx -t
```

### 9.3 GestiÃ³n de Base de Datos

```bash
# Conectar a PostgreSQL
psql -h 101.44.10.71 -U postgres -d pcd_plataforma

# Backup de base de datos
pg_dump -h 101.44.10.71 -U postgres -d pcd_plataforma > backup_$(date +%Y%m%d).sql

# Restaurar backup
psql -h 101.44.10.71 -U postgres -d pcd_plataforma < backup.sql

# Ver tablas
\dt

# Ver conexiones activas
SELECT * FROM pg_stat_activity WHERE datname = 'pcd_plataforma';
```

### 9.4 Deploy de Actualizaciones con Docker

```bash
cd /var/www/pcm/source

# Obtener Ãºltimos cambios del repositorio
git pull origin main

# Reconstruir imagen Docker del backend
docker compose -f docker-compose.prod.yml build

# Reiniciar contenedor con la nueva imagen
docker compose -f docker-compose.prod.yml up -d

# Verificar que el contenedor estÃ¡ corriendo
docker ps

# Recompilar frontend (si hay cambios)
cd frontend
npm ci && npm run build
cp -r dist/* /var/www/pcm/frontend/dist/

# Recargar Nginx para servir nuevos archivos estÃ¡ticos
sudo systemctl reload nginx

# Ver logs para verificar que todo estÃ¡ OK
docker logs -f pcm-backend
```

### 9.5 GestiÃ³n de Archivos Subidos (Storage Local)

```bash
# Ver archivos en el storage
ls -la /var/www/pcm/storage/

# Ver espacio utilizado
du -sh /var/www/pcm/storage/

# Backup del storage
tar -czvf storage_backup_$(date +%Y%m%d).tar.gz /var/www/pcm/storage/

# Verificar permisos (deben ser accesibles por el contenedor)
ls -la /var/www/pcm/storage/
# Propietario debe ser el usuario del contenedor o tener permisos 777
```

---

## 10. VERIFICACIÃ“N DE DESPLIEGUE

### 10.1 Checklist de VerificaciÃ³n

| # | VerificaciÃ³n | Comando | Resultado Esperado |
|---|--------------|---------|-------------------|
| 1 | Contenedor corriendo | `docker ps` | `pcm-backend` con status `Up` |
| 2 | Nginx corriendo | `sudo systemctl status nginx` | `active (running)` |
| 3 | Puerto 5000 escuchando | `docker port pcm-backend` | `5000/tcp -> 0.0.0.0:5000` |
| 4 | Puerto 80 escuchando | `sudo netstat -tlnp \| grep 80` | `nginx` |
| 5 | API responde | `curl http://localhost/api/health` | `200 OK` |
| 6 | Frontend carga | Acceder desde navegador | PÃ¡gina de login |
| 7 | ConexiÃ³n a BD | `docker logs pcm-backend` | Sin errores de conexiÃ³n |
| 8 | Storage montado | `docker exec pcm-backend ls /app/storage` | Directorio accesible |

### 10.2 URLs de Acceso

| Recurso | URL |
|---------|-----|
| **Frontend** | `http://[IP_SERVIDOR]/` |
| **API** | `http://[IP_SERVIDOR]/api/` |
| **Swagger** | `http://[IP_SERVIDOR]/swagger` |
| **Health Check** | `http://[IP_SERVIDOR]/api/health` |

---

## 11. CONCLUSIONES

### 11.1 Estado Actual del Despliegue

| Componente | Estado | ObservaciÃ³n |
|------------|--------|-------------|
| **Base de Datos** | âœ… 100% Operativa | PostgreSQL configurado y accesible |
| **Backend API** | âœ… 100% Operativo | .NET 9 desplegado como servicio |
| **Frontend** | âœ… 100% Operativo | React build desplegado en Nginx |
| **AutenticaciÃ³n** | âœ… Funcional | JWT configurado |
| **Notificaciones Email** | âœ… Operativo | AWS SES configurado con dominio verificado |
| **HTTPS** | âš ï¸ Pendiente | Requiere certificado SSL de SGTD |
| **Storage de PDFs** | âœ… Configurado | Almacenamiento local en `/var/www/pcm/storage` |

### 11.2 Resumen Ejecutivo

La **Plataforma de Cumplimiento Digital** se encuentra operativa en su nÃºcleo funcional:

1. âœ… La **base de datos PostgreSQL** estÃ¡ 100% operativa y accesible, cumpliendo con los requisitos de interoperabilidad establecidos en el TDR.

2. âœ… El **backend .NET 9 en Docker** estÃ¡ desplegado y funcionando como contenedor, con reinicio automÃ¡tico configurado y healthcheck habilitado.

3. âœ… El **frontend React** estÃ¡ compilado y sirviendo a travÃ©s de Nginx con configuraciÃ³n optimizada.

4. âœ… El **almacenamiento de archivos** estÃ¡ configurado localmente en el host mediante volÃºmenes Docker.

5. âœ… El **servicio de email AWS SES** estÃ¡ configurado con dominio verificado `plataformacumplimientodigital.servicios.gob.pe`.

6. âš ï¸ Quedan **pendientes por parte de la SGTD**: certificado SSL y dominio de producciÃ³n.

La transferencia tÃ©cnica garantiza que el **personal de TI de la PCM** pueda:
- Gestionar contenedores Docker (iniciar, detener, actualizar)
- Realizar actualizaciones de cÃ³digo mediante `git pull` y rebuild
- Escalar la soluciÃ³n segÃºn sea necesario
- Administrar la base de datos PostgreSQL
- Monitorear logs de contenedores y Nginx
- Gestionar archivos subidos en el storage local

---

## ANEXOS

### Anexo A: Estructura de Archivos en Servidor con Docker

```
/var/www/pcm/
â”œâ”€â”€ source/                      # CÃ³digo fuente (git clone)
â”‚   â”œâ”€â”€ backend/
â”‚   â”‚   â”œâ”€â”€ PCM.API/
â”‚   â”‚   â”œâ”€â”€ PCM.Application/
â”‚   â”‚   â”œâ”€â”€ PCM.Domain/
â”‚   â”‚   â”œâ”€â”€ PCM.Infrastructure/
â”‚   â”‚   â””â”€â”€ PCM.Shared/
â”‚   â”œâ”€â”€ frontend/
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”œâ”€â”€ Dockerfile               # Dockerfile del backend
â”‚   â””â”€â”€ docker-compose.prod.yml  # ConfiguraciÃ³n de producciÃ³n
â”œâ”€â”€ storage/                     # Volumen: Archivos subidos (PDFs, evidencias)
â”‚   â”œâ”€â”€ evidencias/
â”‚   â””â”€â”€ documentos/
â”œâ”€â”€ logs/                        # Volumen: Logs de aplicaciÃ³n
â”‚   â”œâ”€â”€ nginx-access.log
â”‚   â””â”€â”€ nginx-error.log
â”œâ”€â”€ frontend/
â”‚   â””â”€â”€ dist/                    # React build (archivos estÃ¡ticos)
â”‚       â”œâ”€â”€ index.html
â”‚       â”œâ”€â”€ assets/
â”‚       â””â”€â”€ ...
```

### Anexo B: Puertos Utilizados

| Puerto | Servicio | Protocolo | Acceso |
|--------|----------|-----------|--------|
| 22 | SSH | TCP | Solo administradores |
| 80 | Nginx (HTTP) | TCP | PÃºblico |
| 443 | Nginx (HTTPS) | TCP | PÃºblico (pendiente SSL) |
| 5000 | Docker: pcm-backend | TCP | Solo localhost (via Nginx proxy) |
| 5432 | PostgreSQL | TCP | Restringido por firewall |

### Anexo C: Contenedores Docker

| Contenedor | Imagen Base | Puerto Interno | VolÃºmenes |
|------------|-------------|----------------|-----------|
| `pcm-backend` | `mcr.microsoft.com/dotnet/aspnet:9.0` | 5000 | `/app/storage`, `/app/logs` |

### Anexo D: Comandos Docker RÃ¡pidos

```bash
# Ver contenedores
docker ps -a

# Logs del backend
docker logs -f pcm-backend

# Reiniciar backend
docker restart pcm-backend

# Reconstruir y desplegar
docker compose -f docker-compose.prod.yml up -d --build

# Limpiar imÃ¡genes no usadas
docker image prune -f
```

---

**Documento elaborado el 30 de diciembre de 2025**

**Equipo Consultor de Desarrollo - Plataforma de Cumplimiento Digital**

---

> ğŸ“Œ **RECORDATORIO:** Este documento debe ser tratado como **informaciÃ³n sensible** ya que contiene detalles de configuraciÃ³n de infraestructura. Se recomienda su almacenamiento en ubicaciones con acceso controlado.
