# 5.2.10 Informe de Transferencia T√©cnica

**INFORME T√âCNICO**

**ASUNTO:** Informe de Transferencia T√©cnica: Infraestructura de Datos, Despliegue y Funcionamiento de M√≥dulos ‚Äì Plataforma de Cumplimiento Digital (PCD)

**FECHA:** 30 de diciembre de 2025

**DIRIGIDO A:** Personal de Tecnolog√≠as de la Informaci√≥n - SGTD-PCM

**ELABORADO POR:** Equipo Consultor de Desarrollo

---

## 1. INTRODUCCI√ìN Y ALCANCE

El presente documento detalla las actividades de transferencia t√©cnica correspondientes al **hito 5.2.10** de los T√©rminos de Referencia. Se describe el proceso de configuraci√≥n, despliegue y puesta a punto de la arquitectura de persistencia de datos y l√≥gica de negocio en los servidores de producci√≥n de la PCM.

### 1.1 Objetivos del Documento

- Proporcionar un **manual de instalaci√≥n** completo para el personal t√©cnico de TI
- Documentar la **configuraci√≥n del archivo `appsettings.json`** y variables de entorno
- Detallar la **cadena de conexi√≥n** a la base de datos
- Registrar las dificultades encontradas durante el proceso de despliegue
- Transferir el conocimiento t√©cnico necesario para la operaci√≥n y mantenimiento del sistema

### 1.2 Material Complementario

> üìπ **Video de Transferencia T√©cnica:** Se adjunta un video explicativo de aproximadamente 5 minutos donde se demuestra el proceso de despliegue de la plataforma, incluyendo la configuraci√≥n de servicios y verificaci√≥n de funcionamiento.

---

## 2. DIAGN√ìSTICO DE INFRAESTRUCTURA Y ADECUACI√ìN TECNOL√ìGICA

### 2.1 Discrepancia de Ambientes

Es fundamental precisar que, durante la fase de despliegue, el equipo consultor identific√≥ una **discrepancia cr√≠tica** entre los ambientes proyectados y los ambientes finales asignados:

| Aspecto | Ambiente Proyectado (TDR) | Ambiente Asignado (Real) |
|---------|---------------------------|--------------------------|
| **Sistema Operativo** | Windows Server | Linux Ubuntu 24.04 LTS |
| **Arquitectura** | x86_64 | x86_64 |
| **Tipo de Instancia** | VM Windows | Instancia Linux |

### 2.2 Protocolo de Adecuaci√≥n Ejecutado

Ante este escenario, se ejecut√≥ un **protocolo de adecuaci√≥n de infraestructura no contemplado originalmente**, que incluy√≥:

| Actividad | Descripci√≥n | Estado |
|-----------|-------------|--------|
| **Seguridad Perimetral** | Configuraci√≥n de firewall UFW a nivel de Sistema Operativo | ‚úÖ Completado |
| **Gesti√≥n de Acceso** | Configuraci√≥n de permisos y llaves SSH para acceso seguro | ‚úÖ Completado |
| **Dependencias** | Instalaci√≥n manual de .NET 9 SDK, Node.js 20 LTS, Nginx | ‚úÖ Completado |
| **Optimizaci√≥n Kernel** | Ajustes para gesti√≥n √≥ptima de contenedores y servicios | ‚úÖ Completado |

---

## 3. TRANSFERENCIA T√âCNICA: CAPA DE PERSISTENCIA (DATABASE)

El componente central de la PCD reside en un motor de base de datos relacional robusto, configurado bajo est√°ndares de alta disponibilidad y seguridad institucional.

### 3.1 Especificaciones del Motor de Base de Datos

| Par√°metro | Valor |
|-----------|-------|
| **Software** | PostgreSQL v15.15 |
| **Compilaci√≥n** | x86_64-pc-linux-gnu |
| **Host de Producci√≥n** | `101.44.10.71` |
| **Puerto de Servicio** | `5432` (TCP) |
| **Nombre de Base de Datos** | `pcd_plataforma` |
| **Encoding** | UTF-8 |
| **Collation** | es_PE.UTF-8 |

### 3.2 Cadena de Conexi√≥n

```
Host=101.44.10.71;Port=5432;Database=pcd_plataforma;Username=postgres;Password=[CREDENCIAL_SEGURA]
```

> ‚ö†Ô∏è **NOTA DE SEGURIDAD:** La contrase√±a real debe ser proporcionada por canales seguros y no debe ser almacenada en documentaci√≥n p√∫blica.

### 3.3 Proceso de Hardening y Configuraci√≥n de Acceso

Se han realizado ajustes cr√≠ticos en los archivos de configuraci√≥n del motor para garantizar la **interoperabilidad a nivel nacional** solicitada en el TDR:

#### Archivo `postgresql.conf`
```conf
# Permitir conexiones desde endpoints externos (despu√©s de firewall)
listen_addresses = '*'

# Configuraci√≥n de rendimiento
shared_buffers = 256MB
effective_cache_size = 768MB
maintenance_work_mem = 64MB
checkpoint_completion_target = 0.7
wal_buffers = 7864kB
default_statistics_target = 100
random_page_cost = 1.1
effective_io_concurrency = 200
work_mem = 1310kB
min_wal_size = 1GB
max_wal_size = 4GB
max_worker_processes = 4
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_parallel_maintenance_workers = 2
```

#### Archivo `pg_hba.conf`
```conf
# Autenticaci√≥n local
local   all             postgres                                peer
local   all             all                                     peer

# Autenticaci√≥n IPv4 (con contrase√±a cifrada)
host    all             all             127.0.0.1/32            scram-sha-256
host    all             all             0.0.0.0/0               scram-sha-256

# Autenticaci√≥n IPv6
host    all             all             ::1/128                 scram-sha-256
```

### 3.4 Estructura de Datos (Schema) y Migraci√≥n

Se complet√≥ la migraci√≥n e importaci√≥n de la estructura de datos, compuesta por **61 tablas relacionales** que soportan los siguientes m√≥dulos:

| # | M√≥dulo | Tablas Principales |
|---|--------|-------------------|
| 1 | **Gesti√≥n de Usuarios** | `usuarios`, `perfiles`, `perfil_permisos`, `permisos_modulos` |
| 2 | **Gesti√≥n de Entidades** | `entidades`, `sectores`, `niveles_gobierno`, `ubigeos` |
| 3 | **Marco Regulatorio** | `marcos_normativos`, `tipos_norma` |
| 4 | **Gesti√≥n de Compromisos** | `compromisos_gobierno_digital`, `compromiso_normativas`, `alcances_compromisos` |
| 5 | **Cumplimiento Normativo** | `cumplimientos_normativos`, `cumplimiento_historial`, `criterios_evaluacion` |
| 6 | **Evaluaci√≥n & Cumplimiento** | `evaluacion_respuestas_entidad`, `ceda_evaluacion_cab`, `ceda_evaluacion_det` |
| 7 | **Compromisos Espec√≠ficos** | `com1_lider_gtd` hasta `com21_oficial_gobierno_datos` |

El proceso de migraci√≥n se realiz√≥ mediante:
```bash
# Restauraci√≥n de backup
psql -h 101.44.10.71 -U postgres -d pcd_plataforma < backup_estructura.sql

# Verificaci√≥n de integridad referencial
psql -h 101.44.10.71 -U postgres -d pcd_plataforma -c "SELECT count(*) FROM information_schema.tables WHERE table_schema = 'public';"
```

### 3.5 M√©todos de Administraci√≥n Transferidos

Se han validado **dos canales de acceso** para el equipo t√©cnico de la PCM:

#### Opci√≥n 1: Administraci√≥n v√≠a SSH Tunnel (Recomendado)
```bash
# Crear t√∫nel SSH seguro
ssh -L 5432:localhost:5432 usuario@101.44.10.71

# Conectar desde cliente local
psql -h localhost -p 5432 -U postgres -d pcd_plataforma
```

#### Opci√≥n 2: Conexi√≥n Directa con Cliente gr√°fico
- **DBeaver**: Configurar nueva conexi√≥n PostgreSQL con los par√°metros indicados
- **pgAdmin 4**: Agregar servidor con host, puerto y credenciales

---

## 4. MANUAL DE INSTALACI√ìN

### 4.1 Requisitos del Sistema

| Componente | Requisito M√≠nimo | Recomendado |
|------------|------------------|-------------|
| **Sistema Operativo** | Ubuntu 22.04 LTS | Ubuntu 24.04 LTS |
| **RAM** | 4 GB | 8 GB |
| **CPU** | 2 cores | 4 cores |
| **Almacenamiento** | 20 GB | 50 GB SSD |
| **Red** | 100 Mbps | 1 Gbps |

### 4.2 Dependencias de Software

| Software | Versi√≥n | Prop√≥sito |
|----------|---------|-----------|
| **Docker** | 24.0+ | Contenedorizaci√≥n del Backend |
| **Docker Compose** | 2.20+ | Orquestaci√≥n de contenedores |
| **Node.js** | 20 LTS | Build del Frontend |
| **Nginx** | 1.24+ | Servidor Web / Reverse Proxy |
| **PostgreSQL Client** | 15+ | Herramientas de BD |
| **Git** | 2.40+ | Control de versiones |

### 4.3 Instalaci√≥n Paso a Paso

#### Paso 1: Actualizar Sistema e Instalar Dependencias B√°sicas

```bash
# Actualizar sistema
sudo apt update && sudo apt upgrade -y

# Instalar dependencias b√°sicas
sudo apt install -y \
    curl \
    wget \
    git \
    unzip \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release \
    software-properties-common \
    build-essential
```

#### Paso 2: Instalar Docker y Docker Compose

```bash
# Instalar Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Agregar usuario actual al grupo docker
sudo usermod -aG docker $USER

# Instalar Docker Compose (plugin)
sudo apt install -y docker-compose-plugin

# Verificar instalaci√≥n
docker --version
# Debe mostrar: Docker version 24.x.x

docker compose version
# Debe mostrar: Docker Compose version v2.x.x

# Habilitar Docker para inicio autom√°tico
sudo systemctl enable docker
sudo systemctl start docker
```

> ‚ö†Ô∏è **NOTA:** Despu√©s de agregar el usuario al grupo docker, debe cerrar sesi√≥n y volver a iniciar para que los cambios surtan efecto.

#### Paso 3: Instalar Node.js 20 LTS

```bash
# Instalar NodeSource repository
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# Verificar instalaci√≥n
node --version  # v20.x.x
npm --version   # 10.x.x
```

#### Paso 4: Instalar y Configurar Nginx

```bash
# Instalar Nginx
sudo apt install -y nginx

# Habilitar e iniciar servicio
sudo systemctl enable nginx
sudo systemctl start nginx

# Verificar estado
sudo systemctl status nginx
```

#### Paso 5: Crear Estructura de Directorios

```bash
# Crear directorios de la aplicaci√≥n
sudo mkdir -p /var/www/pcm/{source,backend/publish,frontend/dist,logs}

# Asignar permisos
sudo chown -R $USER:$USER /var/www/pcm
sudo chmod -R 755 /var/www/pcm
```

#### Paso 6: Clonar Repositorio

```bash
cd /var/www/pcm

# Clonar repositorio (requiere credenciales de GitHub)
git clone https://github.com/[REPOSITORIO_INSTITUCIONAL]/pcm.git source

# Verificar clonaci√≥n
ls -la source/
```

#### Paso 7: Compilar Backend (.NET)

```bash
cd /var/www/pcm/source/backend

# Restaurar paquetes NuGet
dotnet restore

# Publicar en modo Release
dotnet publish PCM.API/PCM.API.csproj -c Release -o /var/www/pcm/backend/publish

# Verificar publicaci√≥n
ls -la /var/www/pcm/backend/publish/
# Debe existir: PCM.API.dll
```

#### Paso 8: Compilar Frontend (React)

```bash
cd /var/www/pcm/source/frontend

# Instalar dependencias npm
npm ci

# Crear archivo de configuraci√≥n de producci√≥n
cat > .env.production << 'EOF'
VITE_API_URL=/api
VITE_RECAPTCHA_SITE_KEY=6Lc2mgEsAAAAABvNtpyQFMzwSfgCsGXgFFD8SR4Y
VITE_ENVIRONMENT=production
EOF

# Build de producci√≥n
npm run build

# Copiar a directorio de distribuci√≥n
cp -r dist/* /var/www/pcm/frontend/dist/
```

---

## 5. CONFIGURACI√ìN DEL ARCHIVO `appsettings.json`

### 5.1 Ubicaci√≥n del Archivo

```
/var/www/pcm/backend/publish/appsettings.json
```

### 5.2 Estructura Completa del Archivo

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  
  "ConnectionStrings": {
    "DefaultConnection": "Host=101.44.10.71;Port=5432;Database=pcd_plataforma;Username=postgres;Password=[CONTRASE√ëA_SEGURA]"
  },
  
  "JwtSettings": {
    "SecretKey": "[CLAVE_JWT_MINIMO_32_CARACTERES]",
    "Issuer": "PCM.API",
    "Audience": "PCM.Client",
    "ExpirationMinutes": 60,
    "RefreshTokenExpirationDays": 7
  },
  
  "ReCaptcha": {
    "SecretKey": "[CLAVE_SECRETA_RECAPTCHA]",
    "VerifyUrl": "https://www.google.com/recaptcha/api/siteverify",
    "MinScore": 0.5
  },
  
  "Smtp": {
    "Host": "[SERVIDOR_SMTP_PCM]",
    "Port": 587,
    "Username": "[USUARIO_SMTP]",
    "Password": "[CONTRASE√ëA_SMTP]",
    "FromEmail": "notificaciones@pcm.gob.pe",
    "FromName": "Plataforma de Cumplimiento Digital",
    "EnableSsl": true
  },
  
  "Cors": {
    "Origins": [
      "https://[DOMINIO_PRODUCCION]",
      "http://localhost:5173"
    ]
  },
  
  "FileStorage": {
    "BasePath": "/var/www/pcm/storage",
    "MaxFileSizeMB": 10,
    "AllowedExtensions": [".pdf", ".jpg", ".jpeg", ".png"]
  },
  
  "FrontendUrl": "https://[DOMINIO_PRODUCCION]"
}
```

### 5.3 Descripci√≥n de Par√°metros Cr√≠ticos

| Secci√≥n | Par√°metro | Descripci√≥n | Obligatorio |
|---------|-----------|-------------|-------------|
| **ConnectionStrings** | `DefaultConnection` | Cadena de conexi√≥n a PostgreSQL | ‚úÖ S√≠ |
| **JwtSettings** | `SecretKey` | Clave para firmar tokens JWT (m√≠n. 32 chars) | ‚úÖ S√≠ |
| **JwtSettings** | `ExpirationMinutes` | Tiempo de vida del token en minutos | ‚úÖ S√≠ |
| **ReCaptcha** | `SecretKey` | Clave secreta de Google reCAPTCHA v3 | ‚ö†Ô∏è Recomendado |
| **Smtp** | `Host`, `Username`, `Password` | Credenciales del servidor SMTP institucional | ‚ö†Ô∏è Pendiente SGTD |
| **FileStorage** | `BasePath` | Ruta local para almacenamiento de archivos | ‚úÖ S√≠ |
| **Cors** | `Origins` | Dominios permitidos para CORS | ‚úÖ S√≠ |

### 5.4 Configuraci√≥n Alternativa: Variables de Entorno

En lugar de modificar `appsettings.json`, se pueden usar **variables de entorno** (recomendado para producci√≥n):

```bash
# Crear archivo .env
cat > /var/www/pcm/backend/.env << 'EOF'
# ============================================
# PCM Backend - Variables de Entorno
# ============================================

ASPNETCORE_ENVIRONMENT=Production
ASPNETCORE_URLS=http://0.0.0.0:5000

# Base de Datos PostgreSQL
ConnectionStrings__DefaultConnection=Host=101.44.10.71;Port=5432;Database=pcd_plataforma;Username=postgres;Password=[CONTRASE√ëA]

# JWT Authentication
JwtSettings__SecretKey=[CLAVE_SECRETA_32_CARACTERES_MINIMO]
JwtSettings__Issuer=PCM.API
JwtSettings__Audience=PCM.Client
JwtSettings__ExpirationMinutes=60
JwtSettings__RefreshTokenExpirationDays=7

# Google reCAPTCHA v3
ReCaptcha__SecretKey=[CLAVE_RECAPTCHA]

# Servidor SMTP Institucional (Credenciales proporcionadas por SGTD-PCM)
Smtp__Host=[SERVIDOR_SMTP_PCM]
Smtp__Port=587
Smtp__Username=[USUARIO_SMTP]
Smtp__Password=[CONTRASE√ëA_SMTP]
Smtp__FromEmail=notificaciones@pcm.gob.pe
Smtp__FromName=Plataforma de Cumplimiento Digital
Smtp__EnableSsl=true

# Almacenamiento de Archivos (Local en el Host)
FileStorage__BasePath=/var/www/pcm/storage
FileStorage__MaxFileSizeMB=10

# CORS
Cors__Origins__0=https://[DOMINIO_PRODUCCION]

# URL del Frontend
FrontendUrl=https://[DOMINIO_PRODUCCION]

# Logging
Logging__LogLevel__Default=Information
EOF
```

---

## 6. DESPLIEGUE CON DOCKER

### 6.1 Dockerfile del Backend

El backend se despliega mediante un contenedor Docker. El `Dockerfile` ya est√° incluido en el repositorio:

```dockerfile
# Usar la imagen oficial de .NET 9 SDK para build
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /src

# Copiar archivos de proyecto y restaurar dependencias
COPY backend/PCM.Domain/*.csproj ./backend/PCM.Domain/
COPY backend/PCM.Application/*.csproj ./backend/PCM.Application/
COPY backend/PCM.Infrastructure/*.csproj ./backend/PCM.Infrastructure/
COPY backend/PCM.Shared/*.csproj ./backend/PCM.Shared/
COPY backend/PCM.API/*.csproj ./backend/PCM.API/
RUN dotnet restore backend/PCM.API/PCM.API.csproj

# Copiar todo el c√≥digo y compilar
COPY backend/ ./backend/
WORKDIR /src/backend/PCM.API
RUN dotnet clean && dotnet publish -c Release -o /app/publish --no-restore

# Usar la imagen runtime de .NET 9 para ejecutar
FROM mcr.microsoft.com/dotnet/aspnet:9.0
WORKDIR /app
COPY --from=build /app/publish .

# Crear directorio para almacenamiento de archivos
RUN mkdir -p /app/storage

# Exponer el puerto
EXPOSE 5000

# Comando de inicio
ENTRYPOINT ["dotnet", "PCM.API.dll"]
```

### 6.2 Docker Compose para Producci√≥n

Crear archivo `docker-compose.prod.yml`:

```yaml
version: '3.8'

services:
  pcm-backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pcm-backend
    restart: always
    ports:
      - "5000:5000"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://0.0.0.0:5000
      # Base de Datos
      - ConnectionStrings__DefaultConnection=Host=101.44.10.71;Port=5432;Database=pcd_plataforma;Username=postgres;Password=[CONTRASE√ëA]
      # JWT
      - JwtSettings__SecretKey=[CLAVE_JWT_32_CARACTERES]
      - JwtSettings__Issuer=PCM.API
      - JwtSettings__Audience=PCM.Client
      - JwtSettings__ExpirationMinutes=60
      - JwtSettings__RefreshTokenExpirationDays=7
      # SMTP Institucional (Credenciales PCM)
      - Smtp__Host=[SERVIDOR_SMTP_PCM]
      - Smtp__Port=587
      - Smtp__Username=[USUARIO_SMTP]
      - Smtp__Password=[CONTRASE√ëA_SMTP]
      - Smtp__FromEmail=notificaciones@pcm.gob.pe
      - Smtp__FromName=Plataforma de Cumplimiento Digital
      - Smtp__EnableSsl=true
      # Almacenamiento Local
      - FileStorage__BasePath=/app/storage
      - FileStorage__MaxFileSizeMB=10
      # reCAPTCHA
      - ReCaptcha__SecretKey=[CLAVE_RECAPTCHA]
      # CORS
      - Cors__Origins__0=https://[DOMINIO_PRODUCCION]
      # Frontend URL
      - FrontendUrl=https://[DOMINIO_PRODUCCION]
    volumes:
      # Persistir archivos subidos (PDFs, evidencias)
      - /var/www/pcm/storage:/app/storage
      # Logs
      - /var/www/pcm/logs:/app/logs
    networks:
      - pcm-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  pcm-network:
    driver: bridge
```

### 6.3 Comandos de Despliegue con Docker

```bash
# Crear directorios para vol√∫menes
sudo mkdir -p /var/www/pcm/{storage,logs,frontend/dist}
sudo chown -R $USER:$USER /var/www/pcm

# Clonar repositorio (si no existe)
cd /var/www/pcm
git clone https://github.com/[REPOSITORIO]/pcm.git source
cd source

# Construir imagen Docker
docker compose -f docker-compose.prod.yml build

# Iniciar contenedor en modo detached
docker compose -f docker-compose.prod.yml up -d

# Verificar que el contenedor est√° corriendo
docker ps

# Ver logs del contenedor
docker logs -f pcm-backend
```

### 6.4 Estructura de Directorios con Docker

```
/var/www/pcm/
‚îú‚îÄ‚îÄ source/                      # C√≥digo fuente (git clone)
‚îÇ   ‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îî‚îÄ‚îÄ docker-compose.prod.yml
‚îú‚îÄ‚îÄ storage/                     # Volumen: Archivos subidos (PDFs)
‚îÇ   ‚îú‚îÄ‚îÄ evidencias/
‚îÇ   ‚îî‚îÄ‚îÄ documentos/
‚îú‚îÄ‚îÄ logs/                        # Volumen: Logs de la aplicaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ backend-*.log
‚îÇ   ‚îî‚îÄ‚îÄ nginx-*.log
‚îî‚îÄ‚îÄ frontend/
    ‚îî‚îÄ‚îÄ dist/                    # React build (archivos est√°ticos)
```

### 6.5 Configuraci√≥n de Nginx

Crear archivo `/etc/nginx/sites-available/pcm`:

```nginx
server {
    listen 80;
    server_name [DOMINIO_O_IP];

    # Logs
    access_log /var/www/pcm/logs/nginx-access.log;
    error_log /var/www/pcm/logs/nginx-error.log;

    # Tama√±o m√°ximo de upload (para PDFs)
    client_max_body_size 50M;

    # Frontend - React SPA
    location / {
        root /var/www/pcm/frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;

        # Cache para assets est√°ticos
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # Backend API - Reverse Proxy
    location /api/ {
        proxy_pass http://127.0.0.1:5000/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection keep-alive;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Swagger Documentation
    location /swagger {
        proxy_pass http://127.0.0.1:5000/swagger;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 6.7 Activar Configuraci√≥n Nginx

```bash
# Crear enlace simb√≥lico
sudo ln -s /etc/nginx/sites-available/pcm /etc/nginx/sites-enabled/

# Eliminar configuraci√≥n default (opcional)
sudo rm /etc/nginx/sites-enabled/default

# Verificar configuraci√≥n
sudo nginx -t

# Recargar Nginx
sudo systemctl reload nginx
```

---

## 7. FUNCIONAMIENTO DE LOS M√ìDULOS (L√ìGICA DE NEGOCIO)

### 7.1 Arquitectura de Servicios con Docker

El despliegue de los m√≥dulos sigue una **arquitectura orientada a contenedores**:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        CLIENTE (Browser)                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ HTTPS/HTTP
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         NGINX (Puerto 80/443)                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  Frontend React (/)     ‚îÇ  ‚îÇ  Reverse Proxy (/api)       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  Archivos est√°ticos     ‚îÇ  ‚îÇ  ‚Üí Docker Container :5000   ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              DOCKER CONTAINER: pcm-backend                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ  .NET 9 Runtime + PCM.API.dll                           ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  Controllers ‚Üí Services ‚Üí Handlers ‚Üí DbContext          ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  (MediatR CQRS Pattern)                                 ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ  Vol√∫menes Montados:                                    ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ /var/www/pcm/storage ‚Üí /app/storage (PDFs)           ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ /var/www/pcm/logs ‚Üí /app/logs                        ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ Npgsql Driver
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   PostgreSQL 15 (Puerto 5432)                    ‚îÇ
‚îÇ                   Host: 101.44.10.71                             ‚îÇ
‚îÇ                   Base de Datos: pcd_plataforma                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ               SMTP INSTITUCIONAL (Puerto 587)                    ‚îÇ
‚îÇ               Servidor proporcionado por SGTD-PCM                ‚îÇ
‚îÇ               ‚Ä¢ Notificaciones de cumplimiento                   ‚îÇ
‚îÇ               ‚Ä¢ Recuperaci√≥n de contrase√±a                       ‚îÇ
‚îÇ               ‚Ä¢ Alertas del sistema                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 7.2 Componentes T√©cnicos

| Componente | Tecnolog√≠a | Descripci√≥n |
|------------|------------|-------------|
| **Contenedor** | Docker | Aislamiento y portabilidad |
| **Backend Runtime** | .NET 9.0 | Entorno de ejecuci√≥n de la API |
| **ORM** | Entity Framework Core 9.0 | Mapeo objeto-relacional |
| **Driver PostgreSQL** | Npgsql 9.0.4 | Comunicaci√≥n con la base de datos |
| **Autenticaci√≥n** | JWT Bearer | Tokens de acceso seguros |
| **Validaci√≥n** | FluentValidation | Validaci√≥n de datos de entrada |
| **Documentaci√≥n API** | Swagger/OpenAPI | Documentaci√≥n interactiva |

### 7.3 Seguridad de Capa

- **Autenticaci√≥n JWT**: Cada request a endpoints protegidos requiere token v√°lido
- **Autorizaci√≥n RBAC**: Control de acceso basado en roles (Admin, Operador, Entidad)
- **Validaci√≥n de Entrada**: FluentValidation previene inyecci√≥n de datos maliciosos
- **Queries Parametrizadas**: Entity Framework previene SQL Injection
- **CORS Configurado**: Solo dominios autorizados pueden consumir la API

---

## 8. DIFICULTADES ENCONTRADAS Y PENDIENTES

### 8.1 Dificultades T√©cnicas Resueltas

| # | Dificultad | Impacto | Soluci√≥n Implementada |
|---|------------|---------|----------------------|
| 1 | **Cambio de SO** (Windows ‚Üí Linux) | Alto | Reconfiguraci√≥n completa de scripts de despliegue y uso de Docker |
| 2 | **Configuraci√≥n SSH** sin documentaci√≥n previa | Medio | Generaci√≥n de llaves y configuraci√≥n de acceso |
| 3 | **Permisos de firewall** no documentados | Medio | Apertura de puertos 80, 443, 5432 en UFW |
| 4 | **Falta de certificado SSL** | Medio | Pendiente - se configur√≥ HTTP temporal |
| 5 | **Adaptaci√≥n a Docker** | Medio | Creaci√≥n de Dockerfile y docker-compose para producci√≥n |

### 8.2 Dependencias Pendientes de la SGTD-PCM

Para la **culminaci√≥n del despliegue final** y funcionamiento completo de la plataforma, se requiere que la SGTD-PCM provea los siguientes par√°metros t√©cnicos:

| # | Requerimiento | Descripci√≥n | Formato Esperado | Estado | Responsable |
|---|---------------|-------------|------------------|--------|-------------|
| 1 | **Credenciales SMTP Institucional** | Servidor de correo para notificaciones de cumplimiento, recuperaci√≥n de contrase√±a y alertas | `Host`, `Puerto`, `Usuario`, `Contrase√±a` | üî¥ Pendiente | SGTD |
| 2 | **Certificado SSL** | Certificado para habilitar HTTPS en producci√≥n | Archivos `.crt` y `.key` | üî¥ Pendiente | SGTD |
| 3 | **Dominio de Producci√≥n** | DNS institucional para la plataforma | `cumplimiento.pcm.gob.pe` | üî¥ Pendiente | SGTD |
| 4 | **Credenciales de Repositorio** | Acceso al repositorio institucional de c√≥digo fuente | URL Git + token/credenciales | üî¥ Pendiente | SGTD |

> **NOTA:** El almacenamiento de archivos (PDFs, evidencias) se realizar√° localmente en el servidor host mediante vol√∫menes Docker, por lo que solo se requiere definir la ruta base y asegurar permisos de escritura. La ruta predeterminada configurada es `/var/www/pcm/storage`.

### 8.3 Detalle de Credenciales SMTP Requeridas

Para configurar el servicio de correo electr√≥nico, se necesitan los siguientes datos del servidor SMTP institucional de la PCM:

```
Smtp__Host=[servidor.smtp.pcm.gob.pe]     # Servidor SMTP
Smtp__Port=[587 o 465]                     # Puerto (587 para TLS, 465 para SSL)
Smtp__Username=[usuario@pcm.gob.pe]        # Usuario de autenticaci√≥n
Smtp__Password=[contrase√±a]                # Contrase√±a
Smtp__EnableSsl=[true/false]               # Habilitaci√≥n de cifrado
```

### 8.4 Impacto de Pendientes

| Funcionalidad Afectada | Dependencia Requerida | Criticidad |
|------------------------|----------------------|------------|
| Notificaciones por email | Credenciales SMTP | üî¥ Alta |
| Recuperaci√≥n de contrase√±a | Credenciales SMTP | üî¥ Alta |
| Conexi√≥n segura HTTPS | Certificado SSL | üü° Media |
| URL de producci√≥n final | Dominio institucional | üü° Media |

---

## 9. COMANDOS √öTILES DE ADMINISTRACI√ìN

### 9.1 Gesti√≥n del Contenedor Docker

```bash
# Ver contenedores en ejecuci√≥n
docker ps

# Ver logs del backend en tiempo real
docker logs -f pcm-backend

# Reiniciar contenedor del backend
docker restart pcm-backend

# Detener contenedor
docker stop pcm-backend

# Iniciar contenedor
docker start pcm-backend

# Ver uso de recursos del contenedor
docker stats pcm-backend

# Acceder al shell del contenedor (para debugging)
docker exec -it pcm-backend /bin/bash

# Ver archivos en el storage del contenedor
docker exec pcm-backend ls -la /app/storage
```

### 9.2 Gesti√≥n de Nginx

```bash
# Ver estado de Nginx
sudo systemctl status nginx

# Reiniciar Nginx
sudo systemctl reload nginx

# Ver logs de Nginx
sudo tail -f /var/www/pcm/logs/nginx-error.log
sudo tail -f /var/www/pcm/logs/nginx-access.log

# Verificar configuraci√≥n
sudo nginx -t
```

### 9.3 Gesti√≥n de Base de Datos

```bash
# Conectar a PostgreSQL
psql -h 101.44.10.71 -U postgres -d pcd_plataforma

# Backup de base de datos
pg_dump -h 101.44.10.71 -U postgres -d pcd_plataforma > backup_$(date +%Y%m%d).sql

# Restaurar backup
psql -h 101.44.10.71 -U postgres -d pcd_plataforma < backup.sql

# Ver tablas
\dt

# Ver conexiones activas
SELECT * FROM pg_stat_activity WHERE datname = 'pcd_plataforma';
```

### 9.4 Deploy de Actualizaciones con Docker

```bash
cd /var/www/pcm/source

# Obtener √∫ltimos cambios del repositorio
git pull origin main

# Reconstruir imagen Docker del backend
docker compose -f docker-compose.prod.yml build

# Reiniciar contenedor con la nueva imagen
docker compose -f docker-compose.prod.yml up -d

# Verificar que el contenedor est√° corriendo
docker ps

# Recompilar frontend (si hay cambios)
cd frontend
npm ci && npm run build
cp -r dist/* /var/www/pcm/frontend/dist/

# Recargar Nginx para servir nuevos archivos est√°ticos
sudo systemctl reload nginx

# Ver logs para verificar que todo est√° OK
docker logs -f pcm-backend
```

### 9.5 Gesti√≥n de Archivos Subidos (Storage Local)

```bash
# Ver archivos en el storage
ls -la /var/www/pcm/storage/

# Ver espacio utilizado
du -sh /var/www/pcm/storage/

# Backup del storage
tar -czvf storage_backup_$(date +%Y%m%d).tar.gz /var/www/pcm/storage/

# Verificar permisos (deben ser accesibles por el contenedor)
ls -la /var/www/pcm/storage/
# Propietario debe ser el usuario del contenedor o tener permisos 777
```

---

## 10. VERIFICACI√ìN DE DESPLIEGUE

### 10.1 Checklist de Verificaci√≥n

| # | Verificaci√≥n | Comando | Resultado Esperado |
|---|--------------|---------|-------------------|
| 1 | Contenedor corriendo | `docker ps` | `pcm-backend` con status `Up` |
| 2 | Nginx corriendo | `sudo systemctl status nginx` | `active (running)` |
| 3 | Puerto 5000 escuchando | `docker port pcm-backend` | `5000/tcp -> 0.0.0.0:5000` |
| 4 | Puerto 80 escuchando | `sudo netstat -tlnp \| grep 80` | `nginx` |
| 5 | API responde | `curl http://localhost/api/health` | `200 OK` |
| 6 | Frontend carga | Acceder desde navegador | P√°gina de login |
| 7 | Conexi√≥n a BD | `docker logs pcm-backend` | Sin errores de conexi√≥n |
| 8 | Storage montado | `docker exec pcm-backend ls /app/storage` | Directorio accesible |

### 10.2 URLs de Acceso

| Recurso | URL |
|---------|-----|
| **Frontend** | `http://[IP_SERVIDOR]/` |
| **API** | `http://[IP_SERVIDOR]/api/` |
| **Swagger** | `http://[IP_SERVIDOR]/swagger` |
| **Health Check** | `http://[IP_SERVIDOR]/api/health` |

---

## 11. CONCLUSIONES

### 11.1 Estado Actual del Despliegue

| Componente | Estado | Observaci√≥n |
|------------|--------|-------------|
| **Base de Datos** | ‚úÖ 100% Operativa | PostgreSQL configurado y accesible |
| **Backend API** | ‚úÖ 100% Operativo | .NET 9 desplegado como servicio |
| **Frontend** | ‚úÖ 100% Operativo | React build desplegado en Nginx |
| **Autenticaci√≥n** | ‚úÖ Funcional | JWT configurado |
| **Notificaciones Email** | ‚ö†Ô∏è Pendiente | Requiere credenciales SMTP institucional de SGTD |
| **HTTPS** | ‚ö†Ô∏è Pendiente | Requiere certificado SSL de SGTD |
| **Storage de PDFs** | ‚úÖ Configurado | Almacenamiento local en `/var/www/pcm/storage` |

### 11.2 Resumen Ejecutivo

La **Plataforma de Cumplimiento Digital** se encuentra operativa en su n√∫cleo funcional:

1. ‚úÖ La **base de datos PostgreSQL** est√° 100% operativa y accesible, cumpliendo con los requisitos de interoperabilidad establecidos en el TDR.

2. ‚úÖ El **backend .NET 9 en Docker** est√° desplegado y funcionando como contenedor, con reinicio autom√°tico configurado y healthcheck habilitado.

3. ‚úÖ El **frontend React** est√° compilado y sirviendo a trav√©s de Nginx con configuraci√≥n optimizada.

4. ‚úÖ El **almacenamiento de archivos** est√° configurado localmente en el host mediante vol√∫menes Docker.

5. ‚ö†Ô∏è Quedan **pendientes por parte de la SGTD**: credenciales SMTP institucional, certificado SSL y dominio de producci√≥n.

La transferencia t√©cnica garantiza que el **personal de TI de la PCM** pueda:
- Gestionar contenedores Docker (iniciar, detener, actualizar)
- Realizar actualizaciones de c√≥digo mediante `git pull` y rebuild
- Escalar la soluci√≥n seg√∫n sea necesario
- Administrar la base de datos PostgreSQL
- Monitorear logs de contenedores y Nginx
- Gestionar archivos subidos en el storage local

---

## ANEXOS

### Anexo A: Estructura de Archivos en Servidor con Docker

```
/var/www/pcm/
‚îú‚îÄ‚îÄ source/                      # C√≥digo fuente (git clone)
‚îÇ   ‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PCM.API/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PCM.Application/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PCM.Domain/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PCM.Infrastructure/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PCM.Shared/
‚îÇ   ‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile               # Dockerfile del backend
‚îÇ   ‚îî‚îÄ‚îÄ docker-compose.prod.yml  # Configuraci√≥n de producci√≥n
‚îú‚îÄ‚îÄ storage/                     # Volumen: Archivos subidos (PDFs, evidencias)
‚îÇ   ‚îú‚îÄ‚îÄ evidencias/
‚îÇ   ‚îî‚îÄ‚îÄ documentos/
‚îú‚îÄ‚îÄ logs/                        # Volumen: Logs de aplicaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ nginx-access.log
‚îÇ   ‚îî‚îÄ‚îÄ nginx-error.log
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îî‚îÄ‚îÄ dist/                    # React build (archivos est√°ticos)
‚îÇ       ‚îú‚îÄ‚îÄ index.html
‚îÇ       ‚îú‚îÄ‚îÄ assets/
‚îÇ       ‚îî‚îÄ‚îÄ ...
```

### Anexo B: Puertos Utilizados

| Puerto | Servicio | Protocolo | Acceso |
|--------|----------|-----------|--------|
| 22 | SSH | TCP | Solo administradores |
| 80 | Nginx (HTTP) | TCP | P√∫blico |
| 443 | Nginx (HTTPS) | TCP | P√∫blico (pendiente SSL) |
| 5000 | Docker: pcm-backend | TCP | Solo localhost (via Nginx proxy) |
| 5432 | PostgreSQL | TCP | Restringido por firewall |

### Anexo C: Contenedores Docker

| Contenedor | Imagen Base | Puerto Interno | Vol√∫menes |
|------------|-------------|----------------|-----------|
| `pcm-backend` | `mcr.microsoft.com/dotnet/aspnet:9.0` | 5000 | `/app/storage`, `/app/logs` |

### Anexo D: Comandos Docker R√°pidos

```bash
# Ver contenedores
docker ps -a

# Logs del backend
docker logs -f pcm-backend

# Reiniciar backend
docker restart pcm-backend

# Reconstruir y desplegar
docker compose -f docker-compose.prod.yml up -d --build

# Limpiar im√°genes no usadas
docker image prune -f
```

---

**Documento elaborado el 30 de diciembre de 2025**

**Equipo Consultor de Desarrollo - Plataforma de Cumplimiento Digital**

---

> üìå **RECORDATORIO:** Este documento debe ser tratado como **informaci√≥n sensible** ya que contiene detalles de configuraci√≥n de infraestructura. Se recomienda su almacenamiento en ubicaciones con acceso controlado.
