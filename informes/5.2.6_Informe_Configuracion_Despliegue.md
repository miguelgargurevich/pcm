# INFORME 5.2.6: CONFIGURACIÃ“N Y DESPLIEGUE

**Plataforma de Cumplimiento Digital**  
**SecretarÃ­a de Gobierno y TransformaciÃ³n Digital - PCM**

---

## INFORMACIÃ“N DEL DOCUMENTO

| Campo | Valor |
|-------|-------|
| **VersiÃ³n** | 1.0.0 |
| **Fecha de EmisiÃ³n** | 22 de noviembre de 2025 |
| **Elaborado por** | Equipo DevOps - SGTD |
| **Estado** | Final |
| **ClasificaciÃ³n** | Uso Interno |

---

## ÃNDICE

1. [IntroducciÃ³n](#1-introducciÃ³n)
2. [Arquitectura de Despliegue](#2-arquitectura-de-despliegue)
3. [ConfiguraciÃ³n de Entornos](#3-configuraciÃ³n-de-entornos)
4. [Base de Datos](#4-base-de-datos)
5. [Backend (.NET 9.0)](#5-backend-net-90)
6. [Frontend (React)](#6-frontend-react)
7. [Seguridad y Certificados](#7-seguridad-y-certificados)
8. [Monitoreo y Logs](#8-monitoreo-y-logs)
9. [Backup y RecuperaciÃ³n](#9-backup-y-recuperaciÃ³n)
10. [Procedimientos de Despliegue](#10-procedimientos-de-despliegue)

---

## 1. INTRODUCCIÃ“N

### 1.1 Objetivo del Informe

Documentar la configuraciÃ³n, infraestructura y procedimientos de despliegue de la Plataforma de Cumplimiento Digital en sus diferentes entornos (desarrollo, staging, producciÃ³n).

### 1.2 Alcance

- ConfiguraciÃ³n de servidores y servicios
- Variables de entorno por ambiente
- Procedimientos de despliegue
- Estrategias de backup y recuperaciÃ³n
- Monitoreo y alertas
- Escalabilidad y alta disponibilidad

### 1.3 Audiencia

- Equipo DevOps
- Administradores de sistemas
- Desarrolladores
- Equipo de soporte tÃ©cnico

---

## 2. ARQUITECTURA DE DESPLIEGUE

### 2.1 Diagrama de Arquitectura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      INTERNET                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Cloudflare CDN      â”‚
         â”‚   (DNS + WAF)         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Load Balancer       â”‚
         â”‚   (nginx/HAProxy)     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚
         â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend       â”‚     â”‚   Backend       â”‚
â”‚  React (Vercel) â”‚     â”‚   .NET (Render) â”‚
â”‚  Port: 443      â”‚     â”‚   Port: 5164    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   PostgreSQL          â”‚
                     â”‚   (Supabase)          â”‚
                     â”‚   Port: 5432          â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Componentes de Infraestructura

| Componente | Servicio |
|------------|----------|
| **Frontend Hosting** | Static Site |
| **Backend API** | Web Service |
| **Base de Datos** | PostgreSQL |
| **CDN** | Content Delivery |
| **DNS** | Domain Management |
| **Storage** | File Storage |
| **Monitoring** | APM |

**Total estimado:** $7-60/mes (dependiendo de trÃ¡fico)

### 2.3 Entornos

| Entorno | PropÃ³sito | URL | Estado |
|---------|-----------|-----|--------|
| **Development** | Desarrollo local | localhost:5173 / localhost:5164 | âœ… Activo |
| **Staging** | Pruebas pre-producciÃ³n | staging.pcm.gob.pe | âš ï¸ Por configurar |
| **Production** | Ambiente productivo | pcm.gob.pe | âš ï¸ Por configurar |

---

## 3. CONFIGURACIÃ“N DE ENTORNOS

### 3.1 Variables de Entorno

#### 3.1.1 Frontend (.env)

**Desarrollo (.env.development):**

```bash
# API Backend
VITE_API_URL=http://localhost:5164/api

# reCAPTCHA
VITE_RECAPTCHA_SITE_KEY=6Lc2mgEsAAAAAMAsjyD9M0MsqCJxpYHS0-prSm9J

# Environment
VITE_ENV=development
VITE_DEBUG=true
```

**ProducciÃ³n (.env.production):**

```bash
# API Backend
VITE_API_URL=https://api.pcm.gob.pe/api

# reCAPTCHA (usar key de producciÃ³n)
VITE_RECAPTCHA_SITE_KEY=<PRODUCTION_KEY>

# Environment
VITE_ENV=production
VITE_DEBUG=false

# Analytics (opcional)
VITE_GA_ID=G-XXXXXXXXXX
```

**GestiÃ³n de Secrets:**

```bash
# NO commitear archivos .env
# Usar .env.example como plantilla

# Vercel: Variables en dashboard
# Settings â†’ Environment Variables
```

#### 3.1.2 Backend (appsettings.json)

**Desarrollo (appsettings.Development.json):**

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5433;Database=plataforma_cumplimiento_digital;Username=dashboard_user;Password=dashboard_pass"
  },
  "JwtSettings": {
    "SecretKey": "PCM_SecretKey_2025_Development_MinimumLength32Characters",
    "Issuer": "PCM.API",
    "Audience": "PCM.Client",
    "ExpirationMinutes": 60,
    "RefreshTokenExpirationDays": 7
  },
  "ReCaptcha": {
    "SecretKey": "<DEV_SECRET_KEY>",
    "SiteKey": "6Lc2mgEsAAAAAMAsjyD9M0MsqCJxpYHS0-prSm9J",
    "MinimumScore": 0.3
  },
  "Cors": {
    "Origins": [
      "http://localhost:5173",
      "http://localhost:3000"
    ]
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Information"
    }
  }
}
```

**ProducciÃ³n (appsettings.Production.json):**

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "${DATABASE_URL}"
  },
  "JwtSettings": {
    "SecretKey": "${JWT_SECRET_KEY}",
    "Issuer": "PCM.API.Production",
    "Audience": "PCM.Client.Production",
    "ExpirationMinutes": 30,
    "RefreshTokenExpirationDays": 7
  },
  "ReCaptcha": {
    "SecretKey": "${RECAPTCHA_SECRET_KEY}",
    "SiteKey": "${RECAPTCHA_SITE_KEY}",
    "MinimumScore": 0.5
  },
  "Cors": {
    "Origins": [
      "https://pcm.gob.pe",
      "https://www.pcm.gob.pe"
    ]
  },
  "Logging": {
    "LogLevel": {
      "Default": "Warning",
      "Microsoft.AspNetCore": "Error",
      "Microsoft.EntityFrameworkCore": "Error"
    }
  }
}
```

**Variables en Render.com:**

```bash
# Dashboard Render â†’ Environment
DATABASE_URL=postgresql://user:pass@host:5432/db
JWT_SECRET_KEY=<SECRET_64_CHARS>
RECAPTCHA_SECRET_KEY=<SECRET>
ASPNETCORE_ENVIRONMENT=Production
```

### 3.2 Secrets Management

#### 3.2.1 Desarrollo

```bash
# User Secrets (.NET)
dotnet user-secrets init
dotnet user-secrets set "JwtSettings:SecretKey" "dev-secret-key"
dotnet user-secrets set "ConnectionStrings:DefaultConnection" "Host=localhost;..."
```

#### 3.2.2 ProducciÃ³n

**Opciones:**

1. **Variables de entorno** (Actual)
   - Render.com environment variables
   - Vercel environment variables

2. **Vault Services** (Recomendado futuro)
   - Azure Key Vault
   - AWS Secrets Manager
   - HashiCorp Vault

3. **EncriptaciÃ³n**
   - Archivos appsettings encriptados
   - DesencriptaciÃ³n en runtime

---

## 4. BASE DE DATOS

### 4.1 PostgreSQL en Supabase

#### 4.1.1 ConfiguraciÃ³n

**Instancia:**
- VersiÃ³n: PostgreSQL 15.x
- RegiÃ³n: us-east-1 (o closest a PerÃº)
- Plan: Free tier inicial â†’ Pro al escalar

**ConexiÃ³n:**

```bash
# Connection String
postgresql://postgres:[YOUR-PASSWORD]@db.[PROJECT-REF].supabase.co:5432/postgres

# Connection Pooling (Recomendado)
postgresql://postgres:[YOUR-PASSWORD]@db.[PROJECT-REF].supabase.co:6543/postgres?pgbouncer=true
```

**ConfiguraciÃ³n en Entity Framework:**

```csharp
// Program.cs
builder.Services.AddDbContext<PCMDbContext>(options =>
    options.UseNpgsql(connectionString,
        npgsqlOptions => npgsqlOptions
            .EnableRetryOnFailure(
                maxRetryCount: 3,
                maxRetryDelay: TimeSpan.FromSeconds(30),
                errorCodesToAdd: null)
            .CommandTimeout(30)
    )
);
```

#### 4.1.2 Esquema de Base de Datos

**Tablas principales:**

| Tabla | Registros Estimados | Crecimiento |
|-------|-------------------|-------------|
| `usuarios` | 500 | 50/mes |
| `entidades` | 2,000 | 20/mes |
| `marco_normativo` | 1,000 | 30/mes |
| `compromisos_gobierno_digital` | 21 | Estable |
| `cumplimiento_normativo` | 10,000 | 500/mes |
| `ubigeo` | 1,874 | Estable |
| `tabla_tablas` | 100 | 5/mes |

**Total estimado:** 15,000 registros iniciales â†’ 100,000 en 1 aÃ±o

#### 4.1.3 Ãndices CrÃ­ticos

```sql
-- Usuarios
CREATE INDEX idx_usuarios_email ON usuarios(email);
CREATE INDEX idx_usuarios_dni ON usuarios(dni);
CREATE INDEX idx_usuarios_entidad ON usuarios(entidad_id);

-- Entidades
CREATE INDEX idx_entidades_ruc ON entidades(ruc);
CREATE INDEX idx_entidades_ubigeo ON entidades(ubigeo_id);

-- Marco Normativo
CREATE INDEX idx_marco_normativo_numero ON marco_normativo(numero);
CREATE INDEX idx_marco_normativo_fecha ON marco_normativo(fecha_publicacion);

-- Cumplimiento
CREATE INDEX idx_cumplimiento_entidad ON cumplimiento_normativo(entidad_id);
CREATE INDEX idx_cumplimiento_norma ON cumplimiento_normativo(norma_id);
CREATE INDEX idx_cumplimiento_fecha ON cumplimiento_normativo(fecha_registro);
```

#### 4.1.4 Migraciones

**Estrategia:**

1. **Code-First con EF Core Migrations**
   ```bash
   # Crear migraciÃ³n
   dotnet ef migrations add MigrationName
   
   # Aplicar a BD
   dotnet ef database update
   ```

2. **Scripts SQL manuales** (disponibles en `/db/`)
   - `migracion_completa_supabase.sql` - Setup inicial
   - `PRODUCCION_*.sql` - Actualizaciones incrementales

**Versionado:**

```sql
-- Tabla de control de versiones
CREATE TABLE schema_versions (
    version_id SERIAL PRIMARY KEY,
    version_number VARCHAR(20),
    script_name VARCHAR(255),
    applied_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 4.2 Backup y Restore

#### 4.2.1 Backups AutomÃ¡ticos (Supabase)

- **Daily backups:** AutomÃ¡ticos en plan Pro
- **Point-in-Time Recovery:** Ãšltimos 7 dÃ­as
- **RetenciÃ³n:** 30 dÃ­as (configurable)

#### 4.2.2 Backups Manuales

```bash
# Exportar BD completa
pg_dump -h db.xxx.supabase.co -U postgres -d postgres > backup_$(date +%Y%m%d).sql

# Exportar solo datos
pg_dump -h db.xxx.supabase.co -U postgres -d postgres --data-only > data_$(date +%Y%m%d).sql

# Restaurar
psql -h db.xxx.supabase.co -U postgres -d postgres < backup.sql
```

**Frecuencia recomendada:**
- ProducciÃ³n: Diario (automÃ¡tico) + Semanal (manual offsite)
- Staging: Semanal
- Development: Bajo demanda

---

## 5. BACKEND (.NET 9.0)

### 5.1 Despliegue en Render.com

#### 5.1.1 ConfiguraciÃ³n del Servicio

**Render.com Dashboard:**

```yaml
# render.yaml
services:
  - type: web
    name: pcm-api
    env: docker
    dockerfilePath: ./Dockerfile
    region: oregon
    plan: starter
    buildCommand: ""
    healthCheckPath: /health
    envVars:
      - key: ASPNETCORE_ENVIRONMENT
        value: Production
      - key: DATABASE_URL
        sync: false
      - key: JWT_SECRET_KEY
        generateValue: true
      - key: PORT
        value: 5164
```

#### 5.1.2 Dockerfile

```dockerfile
# Multi-stage build
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /src

# Copiar archivos de proyecto
COPY backend/PCM.Domain/*.csproj ./backend/PCM.Domain/
COPY backend/PCM.Application/*.csproj ./backend/PCM.Application/
COPY backend/PCM.Infrastructure/*.csproj ./backend/PCM.Infrastructure/
COPY backend/PCM.Shared/*.csproj ./backend/PCM.Shared/
COPY backend/PCM.API/*.csproj ./backend/PCM.API/

# Restaurar dependencias
RUN dotnet restore backend/PCM.API/PCM.API.csproj

# Copiar cÃ³digo y compilar
COPY backend/ ./backend/
WORKDIR /src/backend/PCM.API
RUN dotnet clean && dotnet publish -c Release -o /app/publish --no-restore

# Imagen runtime
FROM mcr.microsoft.com/dotnet/aspnet:9.0
WORKDIR /app
COPY --from=build /app/publish .

# Puerto dinÃ¡mico (Render usa PORT env var)
EXPOSE ${PORT:-5164}

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:${PORT:-5164}/health || exit 1

ENTRYPOINT ["dotnet", "PCM.API.dll"]
```

#### 5.1.3 Health Check Endpoint

```csharp
// Program.cs
app.MapGet("/health", async (PCMDbContext db) =>
{
    try
    {
        await db.Database.CanConnectAsync();
        return Results.Ok(new
        {
            status = "healthy",
            timestamp = DateTime.UtcNow,
            version = "1.0.0"
        });
    }
    catch (Exception ex)
    {
        return Results.Problem(detail: ex.Message, statusCode: 503);
    }
});
```

### 5.2 Escalabilidad

#### 5.2.1 Horizontal Scaling

**Render.com:**
- Auto-scaling basado en CPU/memoria
- MÃ­nimo: 1 instancia
- MÃ¡ximo: 5 instancias (plan Pro)

**ConfiguraciÃ³n:**

```yaml
# render.yaml
autoscaling:
  enabled: true
  minInstances: 1
  maxInstances: 5
  targetCPUPercent: 70
  targetMemoryPercent: 80
```

#### 5.2.2 Optimizaciones

**CÃ³digo:**

```csharp
// Connection pooling
services.AddDbContext<PCMDbContext>(options =>
{
    options.UseNpgsql(connectionString, npgsqlOptions =>
    {
        npgsqlOptions.MaxBatchSize(100);
        npgsqlOptions.CommandTimeout(30);
    });
}, ServiceLifetime.Scoped, ServiceLifetime.Singleton);

// Output caching
builder.Services.AddOutputCache(options =>
{
    options.AddPolicy("Default", builder =>
        builder.Expire(TimeSpan.FromMinutes(5)));
});

// Response compression
builder.Services.AddResponseCompression(options =>
{
    options.EnableForHttps = true;
});
```

### 5.3 Logs y Monitoreo

#### 5.3.1 Logging

```csharp
// Serilog (recomendado)
builder.Host.UseSerilog((context, configuration) =>
{
    configuration
        .WriteTo.Console()
        .WriteTo.File("logs/pcm-.log", rollingInterval: RollingInterval.Day)
        .MinimumLevel.Override("Microsoft", LogEventLevel.Warning);
});
```

**Niveles de log por ambiente:**

| Ambiente | Nivel | Destino |
|----------|-------|---------|
| Development | Information | Console + File |
| Staging | Warning | Console + Cloud |
| Production | Error | Cloud (Application Insights) |

#### 5.3.2 Monitoreo

**MÃ©tricas clave:**

- Request rate (req/s)
- Response time (p50, p95, p99)
- Error rate (%)
- CPU/Memory usage
- Database connections

**Herramientas:**

- Render Dashboard (bÃ¡sico)
- Application Insights (recomendado)
- Datadog / New Relic (alternativas)

---

## 6. FRONTEND (REACT)

### 6.1 Despliegue en Vercel

#### 6.1.1 ConfiguraciÃ³n

**vercel.json:**

```json
{
  "version": 2,
  "builds": [
    {
      "src": "frontend/package.json",
      "use": "@vercel/static-build",
      "config": {
        "distDir": "frontend/dist"
      }
    }
  ],
  "routes": [
    {
      "src": "/assets/(.*)",
      "dest": "/frontend/assets/$1"
    },
    {
      "src": "/(.*)",
      "dest": "/frontend/$1"
    }
  ],
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "X-Frame-Options",
          "value": "DENY"
        },
        {
          "key": "X-Content-Type-Options",
          "value": "nosniff"
        },
        {
          "key": "Referrer-Policy",
          "value": "strict-origin-when-cross-origin"
        }
      ]
    }
  ]
}
```

#### 6.1.2 Build Configuration

**package.json:**

```json
{
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "build:staging": "vite build --mode staging",
    "build:production": "vite build --mode production"
  }
}
```

**vite.config.js:**

```javascript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  build: {
    outDir: 'dist',
    sourcemap: false, // Deshabilitar en producciÃ³n
    rollupOptions: {
      output: {
        manualChunks: {
          'react-vendor': ['react', 'react-dom', 'react-router-dom'],
          'ui-vendor': ['lucide-react']
        }
      }
    }
  },
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://localhost:5164',
        changeOrigin: true
      }
    }
  }
})
```

### 6.2 OptimizaciÃ³n de Build

#### 6.2.1 Bundle Size

```bash
# Analizar bundle
npm run build -- --analyze

# Resultados objetivo:
# - Total bundle: < 500KB (gzipped)
# - Largest chunk: < 200KB
# - First paint: < 2s
```

**Optimizaciones aplicadas:**

- âœ… Code splitting por rutas
- âœ… Lazy loading de componentes
- âœ… Tree shaking automÃ¡tico
- âœ… MinificaciÃ³n CSS/JS
- âœ… CompresiÃ³n gzip/brotli

#### 6.2.2 Cache Strategy

**Vercel CDN:**

```javascript
// Headers automÃ¡ticos
Cache-Control: public, max-age=31536000, immutable  // Assets
Cache-Control: public, max-age=0, must-revalidate   // HTML
```

**Service Worker (futuro PWA):**

```javascript
// Cachear assets estÃ¡ticos
workbox.precaching.precacheAndRoute(self.__WB_MANIFEST);
```

### 6.3 CI/CD con Vercel

#### 6.3.1 Git Integration

**Flujo automÃ¡tico:**

```
main branch â†’ Deploy Production
staging branch â†’ Deploy Preview
pull requests â†’ Deploy Preview
```

**ConfiguraciÃ³n:**

```bash
# Vercel CLI
npm i -g vercel
vercel login
vercel link
vercel --prod  # Deploy producciÃ³n
```

#### 6.3.2 Environment Variables

**Vercel Dashboard:**

```
Settings â†’ Environment Variables

Production:
- VITE_API_URL = https://api.pcm.gob.pe/api
- VITE_RECAPTCHA_SITE_KEY = <PROD_KEY>
- VITE_ENV = production

Preview (Staging):
- VITE_API_URL = https://staging-api.pcm.gob.pe/api
- VITE_RECAPTCHA_SITE_KEY = <STAGING_KEY>
- VITE_ENV = staging
```

---

## 7. SEGURIDAD Y CERTIFICADOS

### 7.1 HTTPS / TLS

#### 7.1.1 Certificados SSL

**Vercel:**
- âœ… SSL automÃ¡tico con Let's Encrypt
- âœ… RenovaciÃ³n automÃ¡tica
- âœ… TLS 1.2+ enforced

**Render:**
- âœ… SSL automÃ¡tico incluido
- âœ… Custom domains soportados
- âœ… HTTPS redirect automÃ¡tico

**ConfiguraciÃ³n backend:**

```csharp
// Program.cs
if (app.Environment.IsProduction())
{
    app.UseHsts();
    app.UseHttpsRedirection();
}
```

#### 7.1.2 Headers de Seguridad

```csharp
// Middleware de seguridad
app.Use(async (context, next) =>
{
    context.Response.Headers.Add("X-Frame-Options", "DENY");
    context.Response.Headers.Add("X-Content-Type-Options", "nosniff");
    context.Response.Headers.Add("X-XSS-Protection", "1; mode=block");
    context.Response.Headers.Add("Referrer-Policy", "strict-origin-when-cross-origin");
    context.Response.Headers.Add("Permissions-Policy", "geolocation=(), microphone=(), camera=()");
    
    if (context.Request.IsHttps)
    {
        context.Response.Headers.Add("Strict-Transport-Security", "max-age=31536000; includeSubDomains");
    }
    
    await next();
});
```

### 7.2 Firewall y WAF

#### 7.2.1 Cloudflare (Recomendado)

**ConfiguraciÃ³n:**

```yaml
DNS:
- A record: pcm.gob.pe â†’ Vercel IP
- A record: api.pcm.gob.pe â†’ Render IP
- Proxy: Enabled (naranja)

Firewall Rules:
- Block paÃ­ses sospechosos
- Rate limiting: 100 req/min
- Challenge on high threat score

SSL/TLS:
- Mode: Full (strict)
- Min TLS: 1.2
- Always Use HTTPS: On
```

**WAF Rules:**

```
- OWASP ModSecurity Core Rule Set
- Block SQL injection patterns
- Block XSS attempts
- Challenge suspicious user agents
```

#### 7.2.2 Rate Limiting (Backend)

```csharp
// Implementar AspNetCoreRateLimit
services.AddMemoryCache();
services.Configure<IpRateLimitOptions>(options =>
{
    options.EnableEndpointRateLimiting = true;
    options.StackBlockedRequests = false;
    options.HttpStatusCode = 429;
    options.RealIpHeader = "X-Real-IP";
    options.GeneralRules = new List<RateLimitRule>
    {
        new RateLimitRule
        {
            Endpoint = "*",
            Period = "1m",
            Limit = 100
        }
    };
});
```

### 7.3 Secrets Rotation

**Procedimiento:**

1. **JWT Secret Key** - Rotar cada 90 dÃ­as
2. **Database Password** - Rotar cada 180 dÃ­as
3. **API Keys** - Rotar anualmente
4. **reCAPTCHA Keys** - Rotar al detectar abuse

```bash
# Script rotaciÃ³n JWT
#!/bin/bash
NEW_SECRET=$(openssl rand -base64 64)
echo "Nuevo JWT Secret: $NEW_SECRET"
# Actualizar en Render environment
# Actualizar en appsettings
# Reiniciar servicio
```

---

## 8. MONITOREO Y LOGS

### 8.1 Application Performance Monitoring

#### 8.1.1 Render Monitoring

**MÃ©tricas built-in:**

- CPU usage
- Memory usage
- Request rate
- Response time
- Error rate

**Dashboards:**
- https://dashboard.render.com/web/[service-id]/metrics

#### 8.1.2 Logging Centralizado

**Opciones:**

1. **Render Logs** (bÃ¡sico)
   ```bash
   # Ver logs en tiempo real
   render logs -s pcm-api --tail
   ```

2. **Application Insights** (recomendado)
   ```csharp
   builder.Services.AddApplicationInsightsTelemetry(options =>
   {
       options.ConnectionString = builder.Configuration["ApplicationInsights:ConnectionString"];
   });
   ```

3. **ELK Stack** (alternativa on-premise)
   - Elasticsearch
   - Logstash
   - Kibana

#### 8.1.3 Alertas

**ConfiguraciÃ³n en Render:**

```yaml
# Dashboard â†’ Alerts
alerts:
  - name: High Error Rate
    condition: error_rate > 5%
    duration: 5m
    channels: [email, slack]
    
  - name: High Response Time
    condition: p95_latency > 1000ms
    duration: 10m
    channels: [email]
    
  - name: Service Down
    condition: health_check_fail
    duration: 2m
    channels: [email, sms]
```

### 8.2 Dashboards

#### 8.2.1 MÃ©tricas Clave (KPIs)

**Backend:**

| MÃ©trica | Objetivo | CrÃ­tico |
|---------|----------|---------|
| Uptime | > 99.5% | < 99% |
| Response Time (p95) | < 500ms | > 2s |
| Error Rate | < 1% | > 5% |
| Throughput | 50+ req/s | < 10 req/s |

**Frontend:**

| MÃ©trica | Objetivo | CrÃ­tico |
|---------|----------|---------|
| First Contentful Paint | < 1.5s | > 3s |
| Largest Contentful Paint | < 2.5s | > 4s |
| Cumulative Layout Shift | < 0.1 | > 0.25 |
| Time to Interactive | < 3s | > 5s |

**Base de Datos:**

| MÃ©trica | Objetivo | CrÃ­tico |
|---------|----------|---------|
| Connection Pool Usage | < 60% | > 90% |
| Query Time (avg) | < 50ms | > 200ms |
| Database Size | < 5GB | > 10GB |
| Active Connections | < 20 | > 50 |

---

## 9. BACKUP Y RECUPERACIÃ“N

### 9.1 Estrategia de Backup

#### 9.1.1 Base de Datos

**Backup AutomÃ¡tico (Supabase):**

```
Frecuencia: Diario
RetenciÃ³n: 30 dÃ­as
Tipo: Full + Incremental
UbicaciÃ³n: S3 (us-east-1)
EncriptaciÃ³n: AES-256
```

**Backup Manual:**

```bash
#!/bin/bash
# Script: backup_db.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backups/postgresql"
DB_HOST="db.xxx.supabase.co"
DB_NAME="postgres"
DB_USER="postgres"

# Crear backup
pg_dump -h $DB_HOST -U $DB_USER -d $DB_NAME \
  -F c -b -v -f "$BACKUP_DIR/backup_$DATE.dump"

# Comprimir
gzip "$BACKUP_DIR/backup_$DATE.dump"

# Subir a S3 (opcional)
aws s3 cp "$BACKUP_DIR/backup_$DATE.dump.gz" \
  s3://pcm-backups/postgresql/

# Limpiar backups antiguos (>30 dÃ­as)
find $BACKUP_DIR -name "*.dump.gz" -mtime +30 -delete

echo "Backup completed: backup_$DATE.dump.gz"
```

**Cron job:**

```cron
# Backup diario a las 2 AM
0 2 * * * /scripts/backup_db.sh >> /logs/backup.log 2>&1
```

#### 9.1.2 CÃ³digo Fuente

**Git:**

```bash
# Repositorio principal: GitHub
git remote -v
origin  https://github.com/miguelgargurevich/pcm.git

# Tags de versiÃ³n
git tag -a v1.0.0 -m "Release 1.0.0"
git push origin v1.0.0

# Branches protegidos
- main (producciÃ³n)
- staging (pruebas)
- develop (desarrollo)
```

**Backup offsite:**

- Mirror en GitLab (recomendado)
- Backup en Azure Repos (alternativa)

#### 9.1.3 Archivos EstÃ¡ticos

**Supabase Storage:**

```javascript
// Backup de archivos adjuntos
const { data, error } = await supabase
  .storage
  .from('documentos')
  .list('evidencias/', {
    limit: 1000,
    offset: 0
  });

// Copiar a bucket de backup
```

### 9.2 Plan de RecuperaciÃ³n ante Desastres (DRP)

#### 9.2.1 RTO y RPO

| Tipo de Desastre | RTO (Recovery Time) | RPO (Recovery Point) |
|------------------|---------------------|---------------------|
| **CaÃ­da de servicio** | < 15 minutos | < 5 minutos |
| **CorrupciÃ³n de BD** | < 1 hora | < 24 horas |
| **PÃ©rdida de datos** | < 4 horas | < 24 horas |
| **Desastre completo** | < 8 horas | < 48 horas |

#### 9.2.2 Procedimientos de RecuperaciÃ³n

**1. Recuperar Base de Datos:**

```bash
# Desde backup automÃ¡tico Supabase
# Dashboard â†’ Backups â†’ Select backup â†’ Restore

# Desde backup manual
pg_restore -h $DB_HOST -U $DB_USER -d $DB_NAME \
  -v backup_YYYYMMDD.dump

# Verificar integridad
psql -h $DB_HOST -U $DB_USER -d $DB_NAME -c \
  "SELECT COUNT(*) FROM usuarios;"
```

**2. Rollback de CÃ³digo:**

```bash
# Ver tags/releases
git tag -l

# Rollback a versiÃ³n anterior
git checkout v1.0.0

# Deploy
vercel --prod  # Frontend
render deploy  # Backend
```

**3. Failover de Servicios:**

```
Primario caÃ­do â†’ Activar secundario
1. Cambiar DNS a IP secundaria
2. Iniciar servicios en standby
3. Verificar conectividad BD
4. Monitorear logs
```

### 9.3 Pruebas de RecuperaciÃ³n

**Calendario:**

| Tipo | Frecuencia | Ãšltima EjecuciÃ³n |
|------|-----------|------------------|
| **Restore BD** | Mensual | âš ï¸ Pendiente |
| **Rollback CÃ³digo** | Trimestral | âš ï¸ Pendiente |
| **Disaster Recovery Full** | Anual | âš ï¸ Pendiente |

---

## 10. PROCEDIMIENTOS DE DESPLIEGUE

### 10.1 Despliegue en Desarrollo

```bash
# 1. Backend
cd backend/PCM.API
dotnet run

# 2. Frontend
cd frontend
npm install
npm run dev

# 3. Base de datos (Docker)
docker run --name pg-dashboard \
  -e POSTGRES_PASSWORD=dashboard_pass \
  -e POSTGRES_USER=dashboard_user \
  -e POSTGRES_DB=plataforma_cumplimiento_digital \
  -p 5433:5432 -d postgres:15

# 4. Aplicar migraciones
dotnet ef database update
```

### 10.2 Despliegue en Staging

```bash
# 1. Merge a staging branch
git checkout staging
git merge develop
git push origin staging

# 2. Vercel auto-deploy (staging preview)
# URL: https://pcm-staging-xxx.vercel.app

# 3. Render auto-deploy
# Dashboard â†’ Deploy â†’ staging branch

# 4. Verificar
curl https://staging-api.pcm.gob.pe/health
```

### 10.3 Despliegue en ProducciÃ³n

#### 10.3.1 Checklist Pre-Deploy

- [ ] Tests pasando (backend + frontend)
- [ ] Migraciones BD revisadas
- [ ] Variables de entorno configuradas
- [ ] Backup de BD realizado
- [ ] Changelog actualizado
- [ ] DocumentaciÃ³n actualizada
- [ ] Stakeholders notificados
- [ ] Ventana de mantenimiento agendada

#### 10.3.2 Proceso de Deploy

```bash
# 1. Tag de versiÃ³n
git checkout main
git merge staging
git tag -a v1.0.0 -m "Release 1.0.0"
git push origin main --tags

# 2. Deploy Frontend (Vercel)
cd frontend
npm run build:production
vercel --prod

# 3. Deploy Backend (Render)
# Auto-deploy desde main branch
# O manual: render deploy -s pcm-api

# 4. Migraciones BD
psql $DATABASE_URL < db/migration_vXXX.sql

# 5. VerificaciÃ³n
curl https://api.pcm.gob.pe/health
curl https://pcm.gob.pe

# 6. Monitoreo post-deploy (30 min)
# - Error rate < 1%
# - Response time < 500ms
# - No errores crÃ­ticos en logs
```

#### 10.3.3 Rollback Plan

```bash
# Si hay problemas:

# 1. Rollback cÃ³digo
git revert HEAD
git push origin main

# 2. Rollback BD (si aplica)
psql $DATABASE_URL < db/rollback_vXXX.sql

# 3. Notificar equipo
# 4. Investigar causa raÃ­z
# 5. Fix y re-deploy
```

### 10.4 Blue-Green Deployment (Futuro)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Users  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Load Bal    â”‚â”€â”€â”€â”€â”€â–¶â”‚  Blue    â”‚ (v1.0)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ (Active) â”‚
     â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Green   â”‚ (v1.1)
                     â”‚ (Idle)   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Deploy: Switch traffic Blue â†’ Green
Rollback: Switch traffic Green â†’ Blue
```

**Beneficios:**
- Zero downtime
- Rollback instantÃ¡neo
- Testing en producciÃ³n

---

## 11. CONCLUSIONES Y RECOMENDACIONES

### 11.1 Estado Actual

**Infraestructura:**

âœ… **Implementado:**
- Frontend en Vercel (auto-deploy)
- Backend en Render (Docker)
- BD PostgreSQL en Supabase
- HTTPS/SSL automÃ¡tico
- Backups automÃ¡ticos BD

âš ï¸ **Pendiente:**
- Staging environment
- CI/CD pipeline completo
- Monitoreo avanzado
- Disaster Recovery testing

### 11.2 Recomendaciones Prioritarias

ğŸ”´ **Alta Prioridad:**

1. **Configurar ambiente Staging**
   - Separar de producciÃ³n
   - Datos de prueba
   - Testing pre-deploy

2. **Implementar CI/CD**
   - GitHub Actions
   - Tests automÃ¡ticos
   - Deploy condicional

3. **Monitoreo Avanzado**
   - Application Insights
   - Alertas configuradas
   - Dashboard central

4. **Disaster Recovery Testing**
   - Probar restore BD mensual
   - Documentar procedimientos
   - Capacitar equipo

ğŸŸ¡ **Media Prioridad:**

5. **Rate Limiting Backend**
6. **CDN para assets estÃ¡ticos**
7. **Blue-Green Deployment**
8. **Logging centralizado (ELK)**

ğŸŸ¢ **Baja Prioridad:**

9. **Multi-regiÃ³n deployment**
10. **Kubernetes orchestration**

### 11.3 Costos Estimados

**Actual (Free/Starter tiers):**

| Servicio | Costo Mensual |
|----------|---------------|
| Vercel (Frontend) | $0 |
| Render (Backend) | $7 |
| Supabase (BD) | $0 |
| Cloudflare (CDN/DNS) | $0 |
| **Total** | **$7/mes** |

**Escalado (ProducciÃ³n):**

| Servicio | Costo Mensual |
|----------|---------------|
| Vercel Pro | $20 |
| Render Standard | $25 |
| Supabase Pro | $25 |
| Cloudflare Pro | $20 |
| Application Insights | $100 |
| **Total** | **$190/mes** |

### 11.4 Roadmap de Infraestructura

**Q1 2026:**
- âœ… Configurar staging
- âœ… CI/CD bÃ¡sico
- âœ… Monitoreo esencial

**Q2 2026:**
- â¬œ Escalamiento horizontal
- â¬œ Blue-Green deployment
- â¬œ Disaster recovery drill

**Q3 2026:**
- â¬œ Multi-regiÃ³n
- â¬œ CDN avanzado
- â¬œ Kubernetes (si justificado)

---

**FIN DEL INFORME 5.2.6**

**Elaborado por:** Equipo DevOps - SGTD  
**Fecha de emisiÃ³n:** 22 de noviembre de 2025  
**VersiÃ³n del documento:** 1.0.0  
**Estado:** Final  
**Aprobado por:** SecretarÃ­a de Gobierno y TransformaciÃ³n Digital - PCM
